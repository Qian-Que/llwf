<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ¦´è²å¿˜è´© Â· åœ¨çº¿æˆ¿é—´ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <!-- Firebase v9 compat ç‰ˆ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: #fefaf3;
      color: #333;
    }
    .root {
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    h1 {
      font-size: 20px;
      text-align: center;
      margin: 6px 0;
    }
    .subtitle {
      font-size: 12px;
      text-align: center;
      color: #888;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #ffb14a;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 2px 0 #d27a25;
      transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.2s;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 0 #d27a25;
    }
    .btn.secondary {
      background: #fff;
      color: #666;
      box-shadow: 0 2px 0 #d0d0d0;
      border: 1px solid #ddd;
    }
    .btn.small {
      padding: 3px 8px;
      font-size: 11px;
      box-shadow: 0 1px 0 #d27a25;
    }
    .btn:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .row.center {
      justify-content: center;
    }
    input, select {
      border-radius: 8px;
      border: 1px solid #ffd799;
      padding: 4px 6px;
      font-size: 14px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #ffe2a4;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      padding: 8px;
      font-size: 13px;
    }
    .players {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .player-card {
      flex: 1 1 calc(50% - 4px);
      background: #fff8e6;
      border-radius: 12px;
      padding: 8px;
      border: 1px solid #ffe2a4;
      font-size: 12px;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .player-card.active {
      border-color: #ff9b3d;
      box-shadow: 0 0 0 2px rgba(255,155,61,0.3);
    }
    .player-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }
    .badge-round {
      font-size: 11px;
      background: #fff;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #ffd1a3;
      color: #c45b16;
    }
    .anger-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #ffe3d6;
      overflow: hidden;
    }
    .anger-fill {
      height: 100%;
      background: linear-gradient(90deg, #ffa25b, #ff4b4b);
      width: 0%;
      transition: width 0.2s;
    }
    .anger-text {
      font-size: 11px;
      color: #555;
      margin-top: 2px;
    }
    .orders-panel {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .orders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    .orders-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 12px;
    }
    .orders-summary span {
      padding: 2px 6px;
      border-radius: 999px;
      background: #fff8e6;
      border: 1px solid #ffe0af;
    }
    .orders-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      max-height: 120px;
      overflow-y: auto;
    }
    .order-card {
      background: #fffceb;
      border-radius: 8px;
      padding: 3px 6px;
      font-size: 11px;
      border: 1px solid #ffe2a4;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .info-box {
      font-size: 13px;
      background: #fff;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid #f0d9ff;
      color: #555;
      line-height: 1.4;
    }
    .status-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .status-actions small {
      color: #999;
    }
    .link-box {
      font-size: 12px;
      background: #fff;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px dashed #ffd1a3;
      line-height: 1.5;
      word-break: break-all;
    }

    /* åº•éƒ¨è§„åˆ™æµ®å±‚ */
    .rules-footer {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 20px);
      max-width: 520px;
      z-index: 900;
      display: flex;
      justify-content: flex-end;
      pointer-events: none;
    }
    .rules-footer-inner {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      width: 100%;
      pointer-events: auto;
    }
    .rules-panel {
      width: 100%;
      background: #fffdf7;
      border-radius: 12px;
      border: 1px solid #ffdba0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.5;
      color: #4b5563;
      display: none;
      max-height: 50vh;
      overflow: auto;
    }
    .rules-panel strong {
      color: #c45b16;
    }
    .rules-panel-title {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 6px;
      color: #b45309;
    }

    /* ç©å®¶æ‰‹æœºæ¨¡å¼ */
    .player-root {
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 10px;
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    .big-card {
      font-size: 18px;
      background: #fff8e6;
      border-radius: 16px;
      border: 1px solid #ffdba0;
      padding: 16px;
      text-align: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    }
    .big-card small {
      display: block;
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .overlay-inner {
      background: #fffdf7;
      border-radius: 12px;
      padding: 12px;
      width: 90%;
      max-width: 360px;
      border: 1px solid #ffdca0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      font-size: 13px;
    }
    .overlay-title {
      font-weight: 600;
      margin-bottom: 6px;
    }
    .fruit-choice-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      justify-content: center;
    }
    .fruit-chip {
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid #ffd1a3;
      background: #fff;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .fruit-chip span {
      font-size: 14px;
    }

    .seat-pill {
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      border-radius: 999px;
      border: 1px solid #ffd1a3;
      padding: 4px 10px;
      font-size: 12px;
      margin-bottom: 4px;
      background: #fff;
    }
    .seat-pill button {
      margin-left: 8px;
    }
    .seat-status {
      font-size: 11px;
      color: #888;
    }

    .other-player-card {
      background: #fdf7ff;
      border-radius: 12px;
      border: 1px solid #ecd7ff;
      padding: 10px 12px;
      font-size: 14px;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .other-player-title {
      font-weight: 700;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .other-player-meta {
      font-size: 13px;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <!-- ä¸»æœºè§†å›¾ï¼ˆåˆ›å»ºæˆ¿é—´ + å…¬å…±ä¿¡æ¯ï¼‰ -->
  <div class="root" id="hostRoot">
    <h1>æ¦´è²å¿˜è´© Â· åœ¨çº¿æˆ¿é—´</h1>
    <div class="subtitle" id="roomInfoSubtitle">æœªåˆ›å»ºæˆ¿é—´</div>

    <div class="card" id="hostSetupCard">
      <div style="margin-bottom:6px;">åˆ›å»ºæˆ¿é—´ï¼ˆæ‰‹æœºä¸Šä¹Ÿå¯ä»¥å½“æˆ¿ä¸»ï¼‰</div>
      <div class="row" style="margin-bottom:4px;">
        <label>æˆ¿é—´å·ï¼š
          <input id="roomIdInput" style="width:100px;" placeholder="å¦‚ 1234" />
        </label>
        <button class="btn small" onclick="genRandomRoomId()">éšæœº</button>
      </div>
      <div style="margin-bottom:4px;">
        ç©å®¶äººæ•°ï¼š
        <select id="hostPlayerCount">
          <option value="2">2 äºº</option>
          <option value="3">3 äºº</option>
          <option value="4">4 äºº</option>
        </select>
      </div>
      <div style="font-size:12px;margin-bottom:4px;">å¯é€‰ï¼šä¸ºæ¯ä¸ªåº§ä½å¡«æ˜µç§°ï¼Œæ–¹ä¾¿è¾¨è®¤ã€‚</div>
      <div id="hostNameInputs" style="display:flex;flex-direction:column;gap:4px;margin-bottom:6px;">
        <input id="hostName0" placeholder="ç©å®¶1æ˜µç§°ï¼ˆå¯é€‰ï¼‰" />
        <input id="hostName1" placeholder="ç©å®¶2æ˜µç§°ï¼ˆå¯é€‰ï¼‰" />
        <input id="hostName2" placeholder="ç©å®¶3æ˜µç§°ï¼ˆå¯é€‰ï¼‰" />
        <input id="hostName3" placeholder="ç©å®¶4æ˜µç§°ï¼ˆå¯é€‰ï¼‰" />
      </div>
      <button class="btn" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
    </div>

    <div class="card" id="joinRoomByCodeCard">
      <div style="font-size:13px;margin-bottom:4px;">å·²æœ‰æˆ¿é—´å·ï¼Ÿè¾“å…¥åŠ å…¥ï¼ˆç©å®¶æ¨¡å¼ï¼‰</div>
      <div class="row">
        <input id="joinRoomInput" placeholder="æˆ¿é—´å·å¦‚ 1234" style="flex:1;min-width:0;">
        <button class="btn" onclick="joinRoomByCode()">åŠ å…¥æˆ¿é—´</button>
      </div>
    </div>

    <div class="card" id="joinLinksCard" style="display:none;">
      <div style="margin-bottom:4px;">ç©å®¶åŠ å…¥æ–¹å¼</div>
      <div id="joinLinksBox" class="link-box" style="margin-bottom:6px;"></div>
      <button class="btn small" onclick="openLocalPlayer()">åœ¨æœ¬æœºä»¥ç©å®¶æ¨¡å¼æ‰“å¼€ï¼ˆå¯é€‰ï¼‰</button>
    </div>

    <div class="card" id="playersCard" style="display:none;">
      <div class="players" id="playersContainer"></div>
    </div>

    <div class="card" id="controlCard" style="display:none;">
      <div class="row center" style="margin-bottom:6px;">
        <button class="btn" id="startGameBtn" onclick="hostStartOrRestart()" disabled>â–¶ï¸ å¼€å§‹æ¸¸æˆ</button>
      </div>
      <div class="row center" style="margin-bottom:6px;">
        <button class="btn" id="drawBtn" onclick="hostDrawClick()" disabled>ğŸ‰ æ‘¸ç‰Œå¹¶ä¸‹è®¢å•</button>
        <button class="btn secondary" id="bellBtn" onclick="hostBellClick()" disabled>ğŸ”” æ‘‡é“ƒè´¨ç–‘</button>
        <button class="btn secondary" onclick="resetGame()">é‡ç½®æ•´åœº</button>
        <button class="btn secondary" id="nextRoundBtn" onclick="hostNextRoundClick()" disabled>â¡ï¸ ä¸‹ä¸€å›åˆ</button>
      </div>
      <div class="orders-panel">
        <div class="orders-header">
          <span>è®¢å•åŒº</span>
          <span>æœ€åä¸‹å•ï¼š<strong id="lastOrderPlayerLabel">æš‚æ— </strong></span>
        </div>
        <div class="orders-summary" id="ordersSummary">
          å½“å‰è¿˜æ²¡æœ‰è®¢å•ã€‚
        </div>
        <div class="orders-list" id="ordersList"></div>
      </div>
    </div>

    <div class="info-box" id="infoBox">
      åœ¨ä¸Šæ–¹åˆ›å»ºæˆ¿é—´ï¼›æˆ¿é—´å»ºç«‹åï¼Œåº§ä½åæ»¡å¹¶ç”±æˆ¿ä¸»ç‚¹å‡»ã€Œå¼€å§‹æ¸¸æˆã€åæ‰ä¼šå‘ç‰Œã€‚
    </div>
  </div>

  <!-- ç©å®¶æ¨¡å¼ï¼ˆæ‰‹æœºã€è§‚æˆ˜ / å…¥åº§ï¼‰ -->
  <div class="player-root" id="playerRoot">
    <h1>æ¦´è²å¿˜è´© Â· ç©å®¶è§†è§’</h1>
    <div class="subtitle" id="playerRoomLabel">æˆ¿é—´ï¼šâ€” åº§ä½ï¼šè§‚æˆ˜ä¸­</div>

    <div class="card" id="seatCard">
      <div style="font-size:13px;margin-bottom:6px;">åº§ä½ï¼ˆç‚¹å‡»åŠ å…¥ï¼Œå¦åˆ™ä¸ºè§‚æˆ˜ï¼‰</div>
      <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;">
        <input id="nicknameInput" placeholder="è¾“å…¥æ˜µç§°ï¼ˆç•™ç©ºåˆ™ç”¨åº§ä½å·ï¼‰" style="flex:1;min-width:0;" onblur="saveNickname()" value="" />
        <button class="btn small secondary" onclick="saveNickname()">ä¿å­˜æ˜µç§°</button>
      </div>
      <div id="seatList"></div>
    </div>

    <div class="big-card" id="playerCardView">
      æ­£åœ¨è¿æ¥æˆ¿é—´â€¦
      <small>è¯·ç¡®è®¤é“¾æ¥æˆ–æˆ¿é—´å·æ­£ç¡®ï¼Œä¸”æˆ¿ä¸»å·²åˆ›å»ºæˆ¿é—´ã€‚</small>
    </div>

      <div class="card">
        <div id="playerInfoText" style="font-size:13px;">
          ç­‰å¾…æˆ¿ä¸»å¼€å§‹æ¸¸æˆâ€¦
        </div>
        <div class="status-actions">
          <div id="connectionStatus" style="font-size:11px;color:#16a34a;display:none;">
            å·²è¿æ¥åˆ°æˆ¿é—´
          </div>
          <button class="btn small secondary" id="retryConnectBtn" style="display:none;" onclick="manualReconnect()">é‡æ–°å°è¯•è¿æ¥</button>
          <small id="connectionHint" style="display:none;">è¿æ¥å¼‚å¸¸æ—¶ï¼Œå¯ç‚¹å‡»é‡è¯•</small>
        </div>
      </div>

    <div class="card">
      <div style="font-size:13px;margin-bottom:6px;">æ“ä½œ</div>
      <div class="row center">
        <button class="btn" id="pDrawBtn" onclick="playerDrawClick()">ğŸ‰ æ‘¸ç‰Œ</button>
        <button class="btn secondary" id="pBellBtn" onclick="playerBellClick()">ğŸ”” æ‘‡é“ƒ</button>
        <button class="btn secondary" id="pNextBtn" onclick="playerNextRoundClick()">â¡ï¸ ä¸‹ä¸€å›åˆ</button>
      </div>
      <div style="font-size:11px;color:#999;margin-top:4px;">
        æœªåŠ å…¥åº§ä½æ—¶ä¸ºè§‚æˆ˜æ¨¡å¼ï¼Œæ— æ³•æ“ä½œã€‚æ¸¸æˆå¼€å§‹å‰æŒ‰é’®ä¹Ÿä¸å¯ç”¨ã€‚
      </div>
    </div>

    <div class="card">
      <div style="font-size:13px;margin-bottom:4px;">ç»“ç®—åŒº</div>
      <div class="orders-summary" id="ordersSummaryPlayer">
        å½“å‰è¿˜æ²¡æœ‰è®¢å•ã€‚
      </div>
      <div class="orders-list" id="ordersListPlayer"></div>
    </div>

    <!-- å…¶ä»–ç©å®¶ / æ‰€æœ‰ç©å®¶åº“å­˜ -->
    <div class="card" id="othersInvCard" style="display:none;">
      <div id="othersInvTitle" style="font-size:13px;margin-bottom:4px;">å…¶ä»–ç©å®¶åº“å­˜</div>
      <div id="othersInvList"></div>
    </div>

    <div class="card" id="shareCardPlayer">
      <div style="font-size:13px;margin-bottom:4px;">åˆ†äº«æˆ¿é—´é“¾æ¥</div>
      <div class="link-box" id="shareLinkBoxPlayer"></div>
    </div>

    <!-- æˆ¿ä¸»åœ¨ç©å®¶è§†è§’ä¸‹çš„æ§åˆ¶å¡ç‰‡ -->
    <div class="card" id="hostControlInPlayerCard" style="display:none;">
      <div style="font-size:13px;margin-bottom:4px;">æˆ¿ä¸»ç®¡ç†</div>
      <div style="font-size:12px;margin-bottom:6px;">
        ä½ æ˜¯æœ¬æˆ¿é—´æˆ¿ä¸» ğŸ‘‘ï¼Œåº§ä½åæ»¡åå¯ä»¥åœ¨è¿™é‡Œå¼€å§‹æ¸¸æˆã€‚
      </div>
      <button class="btn" id="hostStartGameInPlayerBtn" onclick="hostStartOrRestart()">â–¶ï¸ å¼€å§‹æ¸¸æˆ</button>
      <div style="font-size:11px;color:#999;margin-top:4px;">ï¼ˆæ­¤æŒ‰é’®ä»…åœ¨æœ¬æœºæœ‰æ•ˆï¼‰</div>
    </div>
  </div>

  <!-- è§„åˆ™æŒ‰é’®ï¼ˆä¸¤ä¸ªæ¨¡å¼å…±ç”¨ï¼‰ -->
  <div class="rules-footer" id="rulesFooter">
    <div class="rules-footer-inner">
        <div class="rules-panel" id="rulesPanel">
          <div class="rules-panel-title">è§„åˆ™é€Ÿè§ˆ</div>
          <div>æ¸¸æˆæ²¿ç”¨åŸç‰ˆèŠ‚å¥ï¼Œé™„åŠ å°‘é‡åœ¨çº¿æˆ¿é—´ä¼˜åŒ–ï¼š</div>
          <ul>
            <li>å¼€å§‹å‰åœ¨è®¾ç½®ç•Œé¢é€‰æ‹©äººæ•°å¹¶å¡«å†™æ˜µç§°ï¼ˆå¯ç•™ç©ºï¼‰ã€‚</li>
          </ul>
          <strong>åº“å­˜ä¿¡æ¯å¯è§æ€§ï¼š</strong>
          <ul>
            <li>æ¯ä½ç©å®¶åœ¨å›åˆä¸­<strong>ä¸èƒ½æŸ¥çœ‹è‡ªå·±çš„åº“å­˜ç‰Œ</strong>ï¼Œé¿å…ä¾èµ–å®Œæ•´ä¿¡æ¯å†³ç­–ã€‚</li>
            <li>å…¶ä»–ç©å®¶ï¼ˆåŒ…æ‹¬è§‚æˆ˜è€…ï¼‰å¯ä»¥éšæ—¶æŸ¥çœ‹ä½ çš„åº“å­˜ç‰Œï¼Œæ‰€æœ‰åº“å­˜å¯¹å¤–å…¬å¼€ã€‚</li>
          </ul>
          <strong>å›ºå®šåº“å­˜ç‰Œè¯´æ˜ï¼š</strong>
          <ul>
            <li>ä½¿ç”¨æ¥è¿‘ <strong>28 å¼ æ°´æœåº“å­˜ç‰Œ + 3 å¼ ç‰¹æ®Šç‰Œ</strong> çš„ç»“æ„ï¼Œæ¯å¼ ç‰Œåªæä¾›å°‘é‡åº“å­˜ï¼Œé¿å…ç¦»è°±çˆ†ä»“ã€‚</li>
            <li>å¤§éƒ¨åˆ†ç‰ŒåªåŒ…å«ä¸¤ç§æ°´æœï¼Œæ€»æ•°é‡åœ¨ 2~4 å·¦å³ï¼Œæ›´æ¥è¿‘åŸç‰ˆæ‰‹æ„Ÿã€‚</li>
          </ul>
        <strong>ä¸‰å¼ å¤§çŒ©çŒ©åº“å­˜ç‰Œï¼š</strong>
        <ul>
          <li><strong>0å·å¢¨è²ï¼ˆç´«æ˜Ÿï¼‰</strong>ï¼šå››ç§æ°´æœåº“å­˜å‡ä¸º 0ï¼Œå¯¹è®¢å•æ— é¢å¤–å½±å“ã€‚</li>
          <li><strong>é¦™è•‰å—å¸Œï¼ˆé¦™è•‰ç‰Œï¼‰</strong>ï¼šä½ çš„é¦™è•‰åº“å­˜è§†ä¸ºæ— ç©·å¤§ï¼Œä¸”æœ¬å±€ç»“ç®—æ—¶æ‰€æœ‰é¦™è•‰è®¢å•éƒ½è¢«å–æ¶ˆã€‚</li>
          <li><strong>3å·ç±³å¥‡ï¼ˆç»¿è‰²æ˜Ÿæ˜Ÿï¼‰</strong>ï¼šæœ¬å±€ç»“ç®—æ—¶ï¼Œæ‰€æœ‰æ•°å­—ä¸º 3 çš„è®¢å•å…¨éƒ¨ä½œåºŸï¼ˆä¸åˆ†æ°´æœï¼‰ã€‚</li>
        </ul>
        <strong>è®¢å•ç‰Œï¼ˆåŒæ°´æœäºŒé€‰ä¸€ï¼‰ï¼š</strong>
        <ul>
          <li>æ¯æ¬¡æ‘¸è®¢å•æ—¶ï¼Œç”Ÿæˆä¸€å¼ â€œè®¢å•ç‰Œâ€ï¼šä¸Šé¢æœ‰ <strong>ä¸¤ç§ä¸åŒæ°´æœ</strong>ï¼Œå„æœ‰ä¸€ä¸ªå°æ•°å€¼ï¼ˆ1~3ï¼‰ã€‚</li>
          <li>å½“å‰ç©å®¶åœ¨è¿™ä¸¤ç§æ°´æœä¸­ <strong>é€‰æ‹©ä¸€ç§</strong> ä½œä¸ºè®¢å•åŠ å…¥è®¢å•åŒºï¼Œå…¶ä½™ç©å®¶ä¹Ÿèƒ½çœ‹åˆ°ä¸¤ç§é€‰é¡¹ã€‚</li>
        </ul>
        <strong>ç»ç†æ„¤æ€’å€¼ï¼ˆé€’å¢åˆ¶ï¼‰ï¼š</strong>
        <ul>
          <li>é‡‡ç”¨åŸç‰ˆç±»ä¼¼æœºåˆ¶ï¼šç»ç†æ„¤æ€’æ ‡è®°ä» <strong>1 ç‚¹ã€2 ç‚¹ã€3 ç‚¹â€¦</strong> ä¾æ¬¡é€’å¢ã€‚</li>
          <li>ç¬¬ä¸€æ¬¡è¢«éª‚è·å¾— 1 ç‚¹ï¼Œç¬¬äºŒæ¬¡ 2 ç‚¹ï¼Œç¬¬ä¸‰æ¬¡ 3 ç‚¹â€¦â€¦ç›´åˆ° 7 ç‚¹å°é¡¶ã€‚</li>
          <li>æŸç©å®¶æ„¤æ€’å€¼è¾¾åˆ° 8 ç‚¹æ—¶ï¼Œæ¸¸æˆç«‹å³ç»“æŸï¼Œæ„¤æ€’å€¼æœ€ä½è€…ï¼ˆå¯å¤šäººå¹¶åˆ—ï¼‰è·èƒœã€‚</li>
        </ul>
        <strong>å›åˆä¸ç»“ç®—ï¼š</strong>
        <ul>
          <li>ç©å®¶æŒ‰é¡ºæ—¶é’ˆè½®æµè¡ŒåŠ¨ï¼šæ‘¸è®¢å•ç‰Œ &gt; äºŒé€‰ä¸€ä¸‹å•ï¼Œæˆ–æ‘‡é“ƒè´¨ç–‘ã€‚</li>
          <li>æ¯ä¸€å±€çš„å…ˆæ‰‹ç©å®¶è½®æµå˜æ¢ï¼Œä»¥ä¿è¯ç›¸å¯¹å…¬å¹³ã€‚</li>
          <li>æ‘‡é“ƒåç”±ç³»ç»Ÿè‡ªåŠ¨ç»“ç®—æ‰€æœ‰ç©å®¶åº“å­˜ä¸è®¢å•ï¼ˆä¼šè‡ªåŠ¨åº”ç”¨å¤§çŒ©çŒ©ç‰Œæ•ˆæœï¼‰ã€‚</li>
          <li>ç»“ç®—åä¸ä¼šè‡ªåŠ¨ä¸‹ä¸€å±€ï¼Œéœ€è¦æ‰‹åŠ¨ç‚¹å‡»ã€Œâ¡ï¸ ä¸‹ä¸€å›åˆã€ã€‚</li>
        </ul>
      </div>
      <button class="btn secondary" id="rulesToggleBtn" onclick="toggleRules()">ğŸ“˜ æŸ¥çœ‹è§„åˆ™</button>
    </div>
  </div>

  <!-- åŒæ°´æœäºŒé€‰ä¸€å¼¹çª—ï¼ˆæ‰‹æœºç«¯ï¼‰ -->
  <div class="overlay" id="orderOverlay">
    <div class="overlay-inner">
      <div class="overlay-title" id="orderOverlayTitle">é€‰æ‹©è¦ä¸‹å•çš„æ°´æœ</div>
      <div>ä»ä¸‹é¢ä¸¤ç§æ°´æœä¸­é€‰æ‹©ä¸€ç§åŠ å…¥è®¢å•åŒºã€‚</div>
      <div class="fruit-choice-row">
        <div class="fruit-chip" onclick="playerChooseOrder('A')">
          <span id="orderOptAEmoji">ğŸ‡</span>
          <span id="orderOptAText">è‘¡è„ Ã— 2</span>
        </div>
        <div class="fruit-chip" onclick="playerChooseOrder('B')">
          <span id="orderOptBEmoji">ğŸ“</span>
          <span id="orderOptBText">è‰è“ Ã— 1</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== è¿™é‡Œå¡«ä½ åœ¨ Firebase æ§åˆ¶å°å¤åˆ¶çš„ firebaseConfig ======
    const firebaseConfig = {
  apiKey: "AIzaSyAj_-XDvWzVh82dG2l5W92m94pTGgXb8FI",
  authDomain: "llwf-214bc.firebaseapp.com",
  databaseURL: "https://llwf-214bc-default-rtdb.firebaseio.com",
  projectId: "llwf-214bc",
  storageBucket: "llwf-214bc.firebasestorage.app",
  messagingSenderId: "78615220940",
  appId: "1:78615220940:web:90496b12ed2250072f6869",
  measurementId: "G-6RJTS4WR2T"
   };
    // ========================================================
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function $(id){ return document.getElementById(id); }
    function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function getQueryParam(key){
      const url=new URL(window.location.href);
      return url.searchParams.get(key);
    }

    const FRUITS = [
      { key:"grape", label:"è‘¡è„", emoji:"ğŸ‡" },
      { key:"strawberry", label:"è‰è“", emoji:"ğŸ“" },
      { key:"banana", label:"é¦™è•‰", emoji:"ğŸŒ" },
      { key:"durian", label:"æ¦´è²", emoji:"ğŸˆ" }
    ];
    const ANGER_LIMIT = 8;

    const INVENTORY_BASE_PATTERNS = [
      { grape:1, strawberry:2, banana:0, durian:0 },
      { grape:1, strawberry:3, banana:0, durian:0 },
      { grape:1, strawberry:0, banana:2, durian:0 },
      { grape:0, strawberry:1, banana:2, durian:0 },
      { grape:0, strawberry:0, banana:1, durian:2 },
      { grape:0, strawberry:1, banana:0, durian:2 },
      { grape:1, strawberry:0, banana:0, durian:3 }
    ];
    const INVENTORY_DECK = [];
    for(let i=0;i<4;i++){
      INVENTORY_BASE_PATTERNS.forEach(p=>{
        INVENTORY_DECK.push({
          type:"normal",
          fruits:{grape:p.grape,strawberry:p.strawberry,banana:p.banana,durian:p.durian}
        });
      });
    }
    INVENTORY_DECK.push(
      { type:"zero" },
      { type:"banana_inf", fruits:{grape:0,strawberry:0,banana:0,durian:0} },
      { type:"green_star", fruits:{grape:1,strawberry:1,banana:1,durian:1} }
    );

    function createRandomInventoryCard(){
      const idx=randomInt(0,INVENTORY_DECK.length-1);
      const base=INVENTORY_DECK[idx];
      if(base.type==="zero") return { type:"zero" };
      const fruitsCopy={};
      FRUITS.forEach(f=>{
        fruitsCopy[f.key]=base.fruits && typeof base.fruits[f.key]==="number" ? base.fruits[f.key]:0;
      });
      return { type:base.type, fruits:fruitsCopy };
    }

    function describeInventoryCardShort(card){
      if(!card) return "ï¼ˆæ— ï¼‰";
      if(card.type==="zero") return "0å·å¢¨è²ï¼šå…¨ 0";
      if(card.type==="banana_inf"){
        const parts=[];
        FRUITS.forEach(f=>{
          if(f.key==="banana") parts.push(`${f.emoji}âˆ`);
          else{
            const v=card.fruits && typeof card.fruits[f.key]==="number"?card.fruits[f.key]:0;
            parts.push(`${f.emoji}${v}`);
          }
        });
        return "é¦™è•‰å—å¸Œï¼š" + parts.join(" ");
      }
      if(card.type==="green_star"){
        const parts=[];
        FRUITS.forEach(f=>{
          const v=card.fruits && typeof card.fruits[f.key]==="number"?card.fruits[f.key]:0;
          parts.push(`${f.emoji}${v}`);
        });
        return "3å·ç±³å¥‡ï¼š" + parts.join(" ");
      }
      const parts=[];
      FRUITS.forEach(f=>{
        const v=card.fruits && typeof card.fruits[f.key]==="number"?card.fruits[f.key]:0;
        parts.push(`${f.emoji}${v}`);
      });
      return parts.join(" ");
    }

    function describeInventoryCardForSelf(card){
      if(!card) return "æœ¬å±€å°šæœªå‘æ”¾åº“å­˜ç‰Œã€‚";
      return "ä½ çš„åº“å­˜ç‰Œå·²å‘æ”¾ï¼Œå†…å®¹åœ¨å›åˆä¸­ä¸å¯æŸ¥çœ‹ï¼Œå°†åœ¨ç»“ç®—æ—¶è‡ªåŠ¨ç”Ÿæ•ˆã€‚";
    }

    // ====== ä¸»æœºç«¯çŠ¶æ€ ======
    let roomId = null;
    let playerCount = 2;
    let hostPlayers = [];
    let inventoryCards = [];
    let lastInventoryCards = null;
    let currentPlayer = 0;
    let roundNumber = 1;
    let roundStartPlayer = 0;
    let orders = [];
    let lastOrderPlayer = null;
    let angerToken = 1;
    let choosingOrder = false;
    let pendingOrder = null;
    let canStartNextRound = false;
    let gameOver = false;
    let actionsRef = null;
    let gameStarted = false;
    let hostSeatIndex = null;     // æˆ¿ä¸»æ‰€åœ¨åº§ä½ç´¢å¼•
    let isHostClient = false;     // æœ¬è®¾å¤‡æ˜¯å¦ä¸ºåˆ›å»ºæˆ¿é—´çš„æˆ¿ä¸»
    let rulesOpen = false;        // åº•éƒ¨è§„åˆ™å¼¹å±‚å¼€å…³

    // ç©å®¶ç«¯ï¼šå½“å‰æˆ¿é—´æ•°æ®
    let latestRoomData = null;
    let playerSeat = null;
    let localNickname = localStorage.getItem("llwfNickname") || ""; // å½“å‰è®¾å¤‡çš„æ˜µç§°
    let seatOnlineRef = null;      // å½“å‰åº§ä½çš„åœ¨çº¿çŠ¶æ€å¼•ç”¨ï¼Œç”¨äº onDisconnect
    let heartbeatTimer = null;     // åœ¨çº¿å¿ƒè·³å®šæ—¶å™¨
    let connectionRef = null;      // Firebase è¿æ¥çŠ¶æ€å¼•ç”¨
    let isConnected = true;        // å½“å‰æ˜¯å¦ä¸ Firebase ä¿æŒè¿æ¥
    let reconnectTimer = null;     // è¿æ¥é‡è¯•å®šæ—¶å™¨
    let roomRefCurrent = null;     // ç©å®¶æ¨¡å¼ä¸‹æ­£åœ¨ç›‘å¬çš„æˆ¿é—´å¼•ç”¨
    let roomSnapshotHandler = null; // è®°å½•å½“å‰ç›‘å¬å›è°ƒï¼Œæ–¹ä¾¿é‡æ–°ç»‘å®š
    let roomErrorHandler = null;

    function genRandomRoomId(){
      const id=String(randomInt(1000,9999));
      $("roomIdInput").value=id;
    }

    function createRoom(){
      const rid=$("roomIdInput").value.trim();
      if(!rid){ alert("è¯·å…ˆå¡«æˆ¿é—´å·ï¼ˆæˆ–éšæœºç”Ÿæˆï¼‰"); return; }
      roomId = rid;
      playerCount = parseInt($("hostPlayerCount").value,10)||2;
      hostPlayers = [];
      for(let i=0;i<playerCount;i++){
        const nmEl=$("hostName"+i);
        const nm = nmEl?nmEl.value.trim():"";
        hostPlayers.push({ name:nm||("ç©å®¶"+(i+1)), anger:0, online:false });
      }
      for(let i=playerCount;i<4;i++){
        hostPlayers[i]={ name:"æœªä½¿ç”¨", anger:0, online:false };
      }

      // æœ¬è®¾å¤‡ä¸ºæˆ¿ä¸»
      isHostClient = true;
      hostSeatIndex = null;

      // æŠŠç¬¬ä¸€ä¸ªåº§ä½çš„åå­—ä½œä¸ºæœ¬æœºé»˜è®¤æ˜µç§°
      localNickname = hostPlayers[0].name;

      $("roomInfoSubtitle").textContent="æˆ¿é—´ï¼š"+roomId+"ï¼ˆæˆ¿ä¸»åœ¨æœ¬æœºï¼‰";

      const roomRef=db.ref("rooms/"+roomId);
      roomRef.set({
        createdAt:Date.now(),
        playerCount,
        hostSeat:null,
        players: hostPlayers.map((p,idx)=>({
          name:p.name, anger:0, seat:idx, inventory:null, online:false
        })),
        game:{
          started:false,
          roundNumber:1,
          currentPlayer:0,
          roundStartPlayer:0,
          orders:[],
          lastOrderPlayer:-1,
          angerToken:1,
          infoText:"æˆ¿ä¸»å·²åˆ›å»ºæˆ¿é—´ï¼Œç­‰å¾…åº§ä½åæ»¡å¹¶å¼€å§‹æ¸¸æˆã€‚",
          gameOver:false,
          pendingOrder:null,
          canStartNextRound:false
        }
      });

      // ç›‘å¬ actions é˜Ÿåˆ—
      actionsRef = db.ref("rooms/"+roomId+"/actions");
      actionsRef.remove();
      actionsRef.on("child_added", snap=>{
        const action=snap.val();
        if(!action || action.processed) return;
        handleActionFromQueue(action);
        snap.ref.update({processed:true});
      });

      // ç›‘å¬ playersï¼Œæ›´æ–°åœ¨çº¿çŠ¶æ€ç­‰ UI
      db.ref("rooms/"+roomId+"/players").on("value", snap=>{
        const val = snap.val() || [];
        for(let i=0;i<playerCount;i++){
          const p = val[i];
          if(!p) continue;
          hostPlayers[i].name = p.name || hostPlayers[i].name;
          hostPlayers[i].anger = p.anger || 0;
          hostPlayers[i].online = !!p.online;
        }
        renderHostPlayers();
        updateAngerUI();
        updateTurnIndicators();
        updateStartGameButton();
      });

      // ç›‘å¬ hostSeat å˜åŒ–ï¼ˆæˆ¿ä¸»æ ‡è¯†ï¼‰
      db.ref("rooms/"+roomId+"/hostSeat").on("value", snap=>{
        hostSeatIndex = snap.val();
        renderHostPlayers();
      });

      $("hostSetupCard").style.display="none";
      $("playersCard").style.display="block";
      $("controlCard").style.display="block";
      $("joinLinksCard").style.display="block";
      renderHostPlayers();
      updateAngerUI();
      renderJoinLinks();
      updateStartGameButton();

      // åˆå§‹æ§åˆ¶æŒ‰é’®ç¦ç”¨ï¼ˆæœªå¼€å§‹ï¼‰
      $("drawBtn").disabled=true;
      $("bellBtn").disabled=true;
      $("nextRoundBtn").disabled=true;
      gameStarted=false;
      gameOver=false;
      orders=[];
      lastOrderPlayer=null;
      pendingOrder=null;
      choosingOrder=false;
      clearOrdersUI();

      const msg="æˆ¿é—´å·²åˆ›å»ºï¼Œç­‰å¾…æ‰€æœ‰åº§ä½åæ»¡å¹¶ç”±æˆ¿ä¸»ç‚¹å‡»ã€Œå¼€å§‹æ¸¸æˆã€ã€‚";
      $("infoBox").innerHTML=msg;
      db.ref("rooms/"+roomId+"/game/infoText").set(msg);

      // åˆ›å»ºå®Œæˆåï¼šå½“å‰é¡µé¢ç›´æ¥åˆ‡åˆ°ç©å®¶è§†è§’
      const url = new URL(window.location.href);
      url.searchParams.set("room", roomId);
      url.searchParams.delete("mode");
      window.history.replaceState({}, "", url.toString());
      toggleToPlayerMode();
      initPlayerMode();
      updateHostControlCardVisibility();
    }

    function renderJoinLinks(){
      if(!roomId) return;
      const origin=location.origin+location.pathname;
      const baseUrl=`${origin}?room=${encodeURIComponent(roomId)}`;
      let html="";
      html += `é€šç”¨åŠ å…¥é“¾æ¥ï¼š<br><code>${baseUrl}</code><br><br>`;
      html += `æ‰€æœ‰ç©å®¶ä½¿ç”¨åŒä¸€ä¸ªé“¾æ¥è¿›å…¥ï¼Œç„¶ååœ¨æ‰‹æœºä¸Š<b>ç‚¹å‡»åº§ä½</b>åŠ å…¥æ¸¸æˆã€‚<br>`;
      $("joinLinksBox").innerHTML=html;
    }

    function openLocalPlayer(){
      if(!roomId) return;
      const origin=location.origin+location.pathname;
      const url=`${origin}?room=${encodeURIComponent(roomId)}`;
      window.open(url,"_blank");
    }

    function areSeatsFull(){
      return hostPlayers.slice(0,playerCount).every(p=>p.online);
    }
    function updateStartGameButton(){
      const btn=$("startGameBtn");
      const hostBtnPlayer=$("hostStartGameInPlayerBtn");
      if(!btn) return;
      const full = areSeatsFull();
      const isRestart = gameStarted;
      btn.textContent = isRestart ? "ğŸ”„ é‡æ–°å¼€å§‹" : "â–¶ï¸ å¼€å§‹æ¸¸æˆ";
      btn.disabled = !isRestart && !full;
      if(hostBtnPlayer){
        hostBtnPlayer.textContent = btn.textContent;
        hostBtnPlayer.disabled = btn.disabled;
      }
    }
    function updateHostControlCardVisibility(){
      const card = $("hostControlInPlayerCard");
      if(!card) return;
      card.style.display = isHostClient ? "block" : "none";
    }

    function syncHostClientFlag(hostSeatVal){
      // ä»…å½“æˆ¿é—´å·²æŒ‡å®šæˆ¿ä¸»åº§ä½æ—¶ï¼Œæ‰æ ¹æ®åº§ä½åŒæ­¥æˆ¿ä¸»æ ‡è¯†ï¼›
      // å¦åˆ™ä¿ç•™å½“å‰æ ‡è¯†ï¼ˆç”¨äºæˆ¿ä¸»é¦–æ¬¡å…¥åº§å‰ï¼‰ã€‚
      if(typeof hostSeatVal === "number"){
        isHostClient = (playerSeat !== null && hostSeatVal === playerSeat);
      }
      updateHostControlCardVisibility();
    }

    function renderHostPlayers(){
      const container=$("playersContainer");
      let html="";
      for(let i=0;i<playerCount;i++){
        const p = hostPlayers[i];
        const onlineText = p.online ? "Â·åœ¨çº¿" : "";
        const isHostSeat = (typeof hostSeatIndex === "number" && hostSeatIndex === i);
        const namePrefix = isHostSeat ? "ğŸ‘‘ " : "";
        html += `
          <div class="player-card" id="playerCard${i}">
            <div class="player-title-row">
              <span>${namePrefix}${p.name}ï¼ˆåº§ä½ ${i+1}${onlineText}ï¼‰</span>
              ${i===0?`<span class="badge-round" id="roundBadge">ç¬¬ ${roundNumber} å±€</span>`:""}
            </div>
            <div class="anger-bar"><div class="anger-fill" id="angerFill${i}"></div></div>
            <div class="anger-text">æ„¤æ€’å€¼ï¼š<span id="angerText${i}">${p.anger||0}</span> / ${ANGER_LIMIT}</div>
          </div>
        `;
      }
      container.innerHTML=html;
    }

    function updateAngerUI(){
      for(let i=0;i<playerCount;i++){
        const fill=$("angerFill"+i);
        const txt=$("angerText"+i);
        const v=hostPlayers[i].anger||0;
        if(fill){
          const pct=Math.min(v/ANGER_LIMIT,1)*100;
          fill.style.width=pct+"%";
        }
        if(txt){
          txt.textContent=v;
        }
      }
    }

    function updateTurnIndicators(){
      for(let i=0;i<playerCount;i++){
        const card=$("playerCard"+i);
        if(card) card.classList.remove("active");
      }
      const ac=$("playerCard"+currentPlayer);
      if(ac) ac.classList.add("active");
      const rb=$("roundBadge");
      if(rb) rb.textContent="ç¬¬ "+roundNumber+" å±€";
      if(roomId){
        db.ref("rooms/"+roomId+"/game/currentPlayer").set(currentPlayer);
      }
    }

    function clearOrdersUI(){
      $("ordersList").innerHTML="";
      $("ordersSummary").textContent="å½“å‰è¿˜æ²¡æœ‰è®¢å•ã€‚";
      $("lastOrderPlayerLabel").textContent="æš‚æ— ";
    }

    function updateOrdersSummary(effectiveTotals=null){
      if(orders.length===0){
        $("ordersSummary").textContent="å½“å‰è¿˜æ²¡æœ‰è®¢å•ã€‚";
        return;
      }
      const totals=effectiveTotals||(function(){
        const t={grape:0,strawberry:0,banana:0,durian:0};
        orders.forEach(o=>{t[o.fruitKey]+=o.amount;});
        return t;
      })();
      const frags=[];
      FRUITS.forEach(f=>{
        frags.push(`<span>${f.emoji}${f.label}ï¼š${totals[f.key]}</span>`);
      });
      $("ordersSummary").innerHTML=frags.join("");
    }

    function cardsEqual(a,b){
      if(!a||!b) return false;
      if(a.type!==b.type) return false;
      if(a.type==="zero") return true;
      const keys=["grape","strawberry","banana","durian"];
      for(const k of keys){
        const va=a.fruits && typeof a.fruits[k]==="number"?a.fruits[k]:0;
        const vb=b.fruits && typeof b.fruits[k]==="number"?b.fruits[k]:0;
        if(va!==vb) return false;
      }
      return true;
    }

    function dealNewInventories(){
      const newCards=new Array(playerCount);
      for(let i=0;i<playerCount;i++){
        let card;let tries=0;
        do{
          card=createRandomInventoryCard();
          tries++;
        }while(lastInventoryCards && lastInventoryCards[i] && cardsEqual(card,lastInventoryCards[i]) && tries<10);
        newCards[i]=card;
      }
      inventoryCards=newCards;
      if(roomId){
        const updates={};
        inventoryCards.forEach((card,idx)=>{
          updates["players/"+idx+"/inventory"]=card;
        });
        db.ref("rooms/"+roomId).update(updates);
      }
    }

    function startNewRound(initial){
      gameStarted = true;
      if(inventoryCards && inventoryCards.length===playerCount){
        lastInventoryCards=inventoryCards.slice();
      }else lastInventoryCards=null;

      orders=[];
      lastOrderPlayer=null;
      pendingOrder=null;
      choosingOrder=false;
      canStartNextRound=false;
      $("nextRoundBtn").disabled=true;
      $("drawBtn").disabled=false;
      $("bellBtn").disabled=false;
      gameOver=false;

      clearOrdersUI();
      dealNewInventories();
      updateOrdersSummary();
      updateTurnIndicators();
      updateStartGameButton();

      const msg=`ç¬¬ ${roundNumber} å±€å¼€å§‹ã€‚å…ˆæ‰‹ï¼š${hostPlayers[currentPlayer].name}`;
      $("infoBox").innerHTML=msg;
      if(roomId){
        db.ref("rooms/"+roomId+"/game").update({
          started:true,
          roundNumber,
          currentPlayer,
          roundStartPlayer,
          orders:[],
          lastOrderPlayer:-1,
          angerToken,
          infoText:msg,
          gameOver:false,
          pendingOrder:null,
          canStartNextRound:false
        });
      }
      updateStartGameButton();
    }

    function resetGame(){
      if(!roomId) return;
      hostPlayers.forEach(p=>p.anger=0);
      angerToken=1;
      roundNumber=1;
      currentPlayer=0;
      roundStartPlayer=0;
      gameOver=false;
      gameStarted=false;
      inventoryCards=[];
      lastInventoryCards=null;
      orders=[];
      lastOrderPlayer=null;
      pendingOrder=null;
      choosingOrder=false;
      canStartNextRound=false;
      updateAngerUI();
      clearOrdersUI();
      $("drawBtn").disabled=true;
      $("bellBtn").disabled=true;
      $("nextRoundBtn").disabled=true;
      updateStartGameButton();

      const msg="å·²é‡ç½®æ•´åœºã€‚ç­‰å¾…æ‰€æœ‰åº§ä½åæ»¡å¹¶ç‚¹å‡»ã€Œå¼€å§‹æ¸¸æˆã€ã€‚";
      $("infoBox").innerHTML=msg;
      db.ref("rooms/"+roomId).update({
        hostSeat: hostSeatIndex,
        players:hostPlayers.map((p,i)=>({
          name:p.name, anger:0, seat:i, inventory:null, online:p.online||false
        })),
        game:{
          started:false,
          roundNumber:1,
          currentPlayer:0,
          roundStartPlayer:0,
          orders:[],
          lastOrderPlayer:-1,
          angerToken:1,
          infoText:msg,
          gameOver:false,
          pendingOrder:null,
          canStartNextRound:false
        }
      });
    }

    function hostStartGame(){
      if(!roomId) return;
      if(gameStarted) return;
      if(!areSeatsFull()){
        alert("åº§ä½å°šæœªåæ»¡ï¼Œæ— æ³•å¼€å§‹æ¸¸æˆã€‚");
        return;
      }
      roundNumber=1;
      roundStartPlayer=0;
      currentPlayer=0;
      angerToken=1;
      gameOver=false;
      startNewRound(true);
    }

    function hostRestartGame(){
      if(!roomId) return;
      hostPlayers.forEach(p=>p.anger=0);
      angerToken=1;
      roundNumber=1;
      roundStartPlayer=0;
      currentPlayer=0;
      gameOver=false;
      gameStarted=false;
      choosingOrder=false;
      pendingOrder=null;
      canStartNextRound=false;
      inventoryCards=[];
      lastInventoryCards=null;
      $("nextRoundBtn").disabled=true;
      $("drawBtn").disabled=true;
      $("bellBtn").disabled=true;
      updateAngerUI();
      clearOrdersUI();
      if(roomId){
        const resetPlayers = hostPlayers.map((p,i)=>({
          name:p.name,
          anger:0,
          seat:i,
          inventory:null,
          online:p.online||false
        }));
        db.ref("rooms/"+roomId+"/players").set(resetPlayers);
      }
      startNewRound(true);
    }

    function hostStartOrRestart(){
      if(gameStarted){
        hostRestartGame();
      }else{
        hostStartGame();
      }
    }

    // ====== actions é˜Ÿåˆ—å¤„ç†ï¼ˆä¸»æœºï¼‰ ======
    function handleActionFromQueue(action){
      if(!roomId) return;
      const type=action.type;
      const seat=action.seat;

      if(type==="draw"){
        if(!gameStarted || gameOver || canStartNextRound) return;
        if(seat!==currentPlayer) return;
        performDraw(seat);
      }else if(type==="bell"){
        if(!gameStarted || gameOver) return;
        performRing(seat);
      }else if(type==="nextRound"){
        performNextRound();
      }else if(type==="chooseA" || type==="chooseB"){
        if(!choosingOrder || !pendingOrder || !gameStarted) return;
        if(seat !== pendingOrder.by) return;
        const side = type==="chooseA" ? "A" : "B";
        applyOrderChoice(side);
      }
    }

    function enqueueAction(type,seat){
      if(!roomId || !actionsRef) return;
      actionsRef.push({
        type, seat, ts:Date.now(), processed:false
      });
    }

    function hostDrawClick(){
      if(gameOver || canStartNextRound || !gameStarted) return;
      enqueueAction("draw", currentPlayer);
    }
    function hostBellClick(){
      if(!gameStarted) return;
      enqueueAction("bell", currentPlayer);
    }
    function hostNextRoundClick(){
      enqueueAction("nextRound", currentPlayer);
    }

    // ====== æ ¸å¿ƒï¼šæ‘¸ç‰Œ & åŒæ°´æœé€‰æ‹©ï¼ˆä¸»æœºåªè®¡ç®—ï¼Œä¸ç‚¹æŒ‰é’®ï¼‰ ======
    function performDraw(seat){
      if(gameOver || canStartNextRound || !gameStarted) return;
      if(choosingOrder) return;

      let idxA=randomInt(0,FRUITS.length-1);
      let idxB;
      do{idxB=randomInt(0,FRUITS.length-1);}while(idxB===idxA);
      const fruitA=FRUITS[idxA];
      const fruitB=FRUITS[idxB];

      const maxAmount=(playerCount===2?2:3);
      const amountA=randomInt(1,maxAmount);
      const amountB=randomInt(1,maxAmount);

      pendingOrder={
        by:seat,
        optionA:{fruitKey:fruitA.key,amount:amountA},
        optionB:{fruitKey:fruitB.key,amount:amountB}
      };
      choosingOrder=true;

      if(roomId){
        db.ref("rooms/"+roomId+"/game/pendingOrder").set({
          by: seat,
          optionA: pendingOrder.optionA,
          optionB: pendingOrder.optionB,
          awaitingChoice: true
        });
      }

      const msg=`${hostPlayers[seat].name} æ‘¸ç‰Œï¼šè¯·åœ¨ TA çš„æ‰‹æœºä¸Šé€‰æ‹©è®¢å•ã€‚`;
      $("infoBox").innerHTML=msg;
      if(roomId) db.ref("rooms/"+roomId+"/game/infoText").set(msg);

      $("drawBtn").disabled=true;
      $("bellBtn").disabled=true;
    }

    function applyOrderChoice(side){
      if(!choosingOrder || !pendingOrder || gameOver || !gameStarted) return;
      const player=pendingOrder.by;
      const opt=side==="A"?pendingOrder.optionA:pendingOrder.optionB;
      const fruit=FRUITS.find(f=>f.key===opt.fruitKey);

      const order={fruitKey:opt.fruitKey,amount:opt.amount,by:player};
      orders.push(order);
      lastOrderPlayer=player;

      const cardEl=document.createElement("div");
      cardEl.className="order-card";
      const icon=document.createElement("span");
      icon.textContent=fruit.emoji;
      const text=document.createElement("span");
      text.textContent=`${fruit.label} Ã— ${opt.amount}ï¼ˆ${hostPlayers[player].name}ï¼‰`;
      cardEl.appendChild(icon);cardEl.appendChild(text);
      $("ordersList").appendChild(cardEl);
      $("ordersList").scrollTop=$("ordersList").scrollHeight;

      updateOrdersSummary();
      $("lastOrderPlayerLabel").textContent=hostPlayers[lastOrderPlayer].name;

      choosingOrder=false;
      pendingOrder=null;
      $("orderOverlay").style.display="none";

      if(roomId){
        db.ref("rooms/"+roomId+"/game/pendingOrder").remove();
      }

      const next=(player+1)%playerCount;
      currentPlayer=next;
      updateTurnIndicators();
      $("drawBtn").disabled=false;
      $("bellBtn").disabled=false;

      const msg=`${hostPlayers[player].name} ä¸‹å•ï¼š${fruit.emoji}${opt.amount}ï¼›ä¸‹ä¸€ä½ï¼š${hostPlayers[next].name}`;
      $("infoBox").innerHTML=msg;
      if(roomId){
        db.ref("rooms/"+roomId+"/game").update({
          orders,
          lastOrderPlayer,
          currentPlayer,
          infoText:msg
        });
      }
    }

    function performRing(seat){
      if(gameOver || canStartNextRound || !gameStarted) return;
      if(choosingOrder) return;
      if(orders.length===0){
        const msg="æ²¡æœ‰è®¢å•ï¼Œä¸èƒ½æ‘‡é“ƒã€‚";
        $("infoBox").innerHTML=msg;
        if(roomId) db.ref("rooms/"+roomId+"/game/infoText").set(msg);
        return;
      }
      if(lastOrderPlayer===null){
        const msg="è¿˜æ²¡æœ‰æœ‰æ•ˆä¸‹å•è®°å½•ï¼Œæš‚ä¸èƒ½ç»“ç®—ã€‚";
        $("infoBox").innerHTML=msg;
        if(roomId) db.ref("rooms/"+roomId+"/game/infoText").set(msg);
        return;
      }
      finalizeBell(seat,lastOrderPlayer);
    }

    function performNextRound(){
      if(!canStartNextRound || gameOver || !gameStarted) return;
      canStartNextRound=false;
      $("nextRoundBtn").disabled=true;
      roundNumber+=1;
      roundStartPlayer=(roundStartPlayer+1)%playerCount;
      currentPlayer=roundStartPlayer;
      startNewRound(false);
    }

    function finalizeBell(challenger,lastOrderP){
      if(gameOver || !gameStarted) return;
      $("drawBtn").disabled=true;
      $("bellBtn").disabled=true;

      const hasMickey=inventoryCards.some(c=>c && c.type==="green_star");
      const hasNancy=inventoryCards.some(c=>c && c.type==="banana_inf");

      const rawTotals={grape:0,strawberry:0,banana:0,durian:0};
      orders.forEach(o=>{rawTotals[o.fruitKey]+=o.amount;});

      const effectiveTotals={grape:0,strawberry:0,banana:0,durian:0};
      let cancelledByMickey=0;
      let cancelledByNancy=0;

      orders.forEach(o=>{
        let cancelled=false;
        if(hasNancy && o.fruitKey==="banana"){ cancelled=true;cancelledByNancy++; }
        if(hasMickey && o.amount===3){ cancelled=true;cancelledByMickey++; }
        if(!cancelled) effectiveTotals[o.fruitKey]+=o.amount;
      });

      const totalInventory={grape:0,strawberry:0,banana:0,durian:0};
      inventoryCards.forEach(card=>{
        if(!card) return;
        if(card.type==="zero"){
        }else if(card.type==="banana_inf"){
          FRUITS.forEach(f=>{
            if(f.key==="banana") totalInventory[f.key]=Infinity;
            else{
              const v=card.fruits && typeof card.fruits[f.key]==="number"?card.fruits[f.key]:0;
              totalInventory[f.key]+=v;
            }
          });
        }else{
          FRUITS.forEach(f=>{
            const v=card.fruits && typeof card.fruits[f.key]==="number"?card.fruits[f.key]:0;
            totalInventory[f.key]+=v;
          });
        }
      });

      let oversold=false;
      FRUITS.forEach(f=>{
        const o=effectiveTotals[f.key];
        const inv=totalInventory[f.key];
        if(o>inv && o>0) oversold=true;
      });

      const angerGain=Math.min(angerToken,7);
      let angryIdx;
      const nameCh=hostPlayers[challenger].name;
      const nameLast=hostPlayers[lastOrderP].name;

      const rawDesc=FRUITS.map(f=>`${f.emoji}${rawTotals[f.key]}`).join("ï¼Œ");
      const effDesc=FRUITS.map(f=>`${f.emoji}${effectiveTotals[f.key]}`).join("ï¼Œ");
      const invDesc=FRUITS.map(f=>{
        const v=totalInventory[f.key];
        return `${f.emoji}${v===Infinity?"âˆ":v}`;
      }).join("ï¼Œ");

      let gorillaInfo="";
      if(hasNancy) gorillaInfo+=`é¦™è•‰å—å¸Œï¼šå–æ¶ˆé¦™è•‰è®¢å• ${cancelledByNancy} å¼ ã€‚`;
      if(hasMickey){
        if(gorillaInfo) gorillaInfo+=" ";
        gorillaInfo+=`3å·ç±³å¥‡ï¼šå–æ¶ˆæ•°å­—ä¸º 3 çš„è®¢å• ${cancelledByMickey} å¼ ã€‚`;
      }

      let resultText="";
      if(oversold){
        angryIdx=lastOrderP;
        hostPlayers[angryIdx].anger+=angerGain;
        resultText=`åˆ¤å®šï¼šçˆ†å•ï¼è´£ä»»äººï¼š${nameLast}ï¼Œ+${angerGain} æ„¤æ€’ã€‚`;
      }else{
        angryIdx=challenger;
        hostPlayers[angryIdx].anger+=angerGain;
        resultText=`åˆ¤å®šï¼šæœªçˆ†å•ã€‚è´£ä»»äººï¼š${nameCh}ï¼ˆè¯¯åˆ¤ï¼‰ï¼Œ+${angerGain} æ„¤æ€’ã€‚`;
      }
      if(angerToken<7) angerToken++;

      updateAngerUI();
      updateOrdersSummary(effectiveTotals);

      let info=
        `ç»“ç®—ï¼šåŸå§‹è®¢å• ${rawDesc}ï¼›æœ‰æ•ˆè®¢å• ${effDesc}ï¼›åº“å­˜ ${invDesc}ã€‚<br>`+
        (gorillaInfo?("ç‰¹æ®Šï¼š"+gorillaInfo+"<br>"):"")+
        resultText+`<br>å½“å‰æ„¤æ€’æ ‡è®°ï¼š${angerToken>7?7:angerToken}ã€‚`;
      $("infoBox").innerHTML=info;

      if(roomId){
        db.ref("rooms/"+roomId).update({
          players:hostPlayers.map((p,i)=>({
            name:p.name, anger:p.anger, seat:i,
            inventory:inventoryCards[i]||null,
            online:p.online||false
          }))
        });
      }

      let someoneOver=null;
      let minAnger=Infinity;
      hostPlayers.forEach((p,idx)=>{
        if(p.anger>=ANGER_LIMIT && someoneOver===null) someoneOver=idx;
        if(p.anger<minAnger) minAnger=p.anger;
      });

      if(someoneOver!==null){
        gameOver=true;
        const winners=[];
        hostPlayers.forEach((p,idx)=>{
          if(p.anger===minAnger) winners.push(idx);
        });
        let endText=
          `<br><strong>${hostPlayers[someoneOver].name} æ„¤æ€’å€¼è¾¾åˆ° ${ANGER_LIMIT}ï¼Œæ¸¸æˆç»“æŸã€‚</strong><br>`;
        if(winners.length===1) endText+=`è·èƒœè€…ï¼š${hostPlayers[winners[0]].name}`;
        else endText+=`è·èƒœè€…ï¼š`+winners.map(i=>hostPlayers[i].name).join("ã€");
        $("infoBox").innerHTML+=endText;

        if(roomId){
          db.ref("rooms/"+roomId+"/game").update({
            infoText:(info+endText).replace(/<[^>]*>/g,""),
            gameOver:true,
            canStartNextRound:false
          });
        }
        $("nextRoundBtn").disabled=true;
        canStartNextRound=false;
      }else{
        const nextRoundNumber=roundNumber+1;
        const predictedStarter=(roundStartPlayer+1)%playerCount;
        $("infoBox").innerHTML+=`<br><br>æœ¬å±€ç»“æŸã€‚ç¬¬ ${nextRoundNumber} å±€å…ˆæ‰‹ï¼š${hostPlayers[predictedStarter].name}`;
        canStartNextRound=true;
        $("nextRoundBtn").disabled=false;

        if(roomId){
          db.ref("rooms/"+roomId+"/game").update({
            orders,
            lastOrderPlayer:-1,
            angerToken,
            infoText:(info).replace(/<[^>]*>/g,""),
            gameOver:false,
            canStartNextRound:true
          });
        }
      }
    }

    // ====== ç©å®¶æ¨¡å¼ ======

    function renderSeatList(players, pc, hostSeatVal){
      const seatListEl = $("seatList");
      if(!seatListEl) return;
      const count = pc || players.length || 0;
      let html = "";
      for(let i=0;i<count;i++){
        const p = players[i] || {};
        const nm = p.name || ("ç©å®¶"+(i+1));
        const online = !!p.online;
        const isMe = (playerSeat === i);
        const isHostSeat = (hostSeatVal === i);

        let status = "";
        if(isMe) status = "æˆ‘å·²åŠ å…¥";
        else if(online) status = "å·²æœ‰ç©å®¶åœ¨çº¿";
        else status = "ç©ºä½";

        const disableJoin = online && !isMe ? "disabled" : "";
        const controlsHtml = isMe
          ? `<button class="btn small secondary" onclick="leaveSeat()">ç¦»å¼€åº§ä½</button>`
          : `<button class="btn small" ${disableJoin} onclick="joinSeat(${i})">åŠ å…¥</button>`;

        const leftText = `åº§ä½ ${i+1}${isHostSeat ? " ğŸ‘‘æˆ¿ä¸»" : ""}ï¼š${nm}` +
          `<span class="seat-status">ï¼ˆ${status}ï¼‰</span>`;

        html += `
          <div class="seat-pill">
            <div>${leftText}</div>
            ${controlsHtml}
          </div>
        `;
      }
      seatListEl.innerHTML = html;
    }

    function updateConnectionStatusUI(val){
      const el = $("connectionStatus");
      const retryBtn = $("retryConnectBtn");
      const hint = $("connectionHint");
      if(!el) return;
      el.style.display = "block";
      if(val){
        el.textContent = "å·²è¿æ¥åˆ°æˆ¿é—´";
        el.style.color = "#16a34a";
        if(retryBtn) retryBtn.style.display = "none";
        if(hint) hint.style.display = "none";
      }else{
        el.textContent = "è¿æ¥ä¸­æ–­ï¼Œæ­£åœ¨å°è¯•é‡è¿â€¦";
        el.style.color = "#c2410c";
        if(retryBtn) retryBtn.style.display = "inline-flex";
        if(hint) hint.style.display = "inline";
      }
    }

    function forceReconnect(reason){
      if(!db || typeof db.goOnline !== "function" || typeof db.goOffline !== "function") return;
      if(reconnectTimer){
        clearTimeout(reconnectTimer);
      }
      const delay = reason === "manual" ? 0 : 600;
      reconnectTimer = setTimeout(()=>{
        try{ db.goOffline(); }catch(e){ console.warn("goOffline å¤±è´¥", e); }
        setTimeout(()=>{
          try{ db.goOnline(); }catch(e){ console.warn("goOnline å¤±è´¥", e); }
        }, 200);
      }, delay);
    }

    function manualReconnect(){
      updateConnectionStatusUI(false);
      forceReconnect("manual");
      reattachRoomListener();
    }

    function setupConnectionWatch(){
      if(connectionRef) return;
      connectionRef = db.ref(".info/connected");
      updateConnectionStatusUI(false);
      connectionRef.on("value", snap => {
        const val = !!snap.val();
        isConnected = val;
        updateConnectionStatusUI(val);
        if(!val && db && typeof db.goOnline === "function"){
          // ä¸»åŠ¨æç¤º Firebase é‡æ–°ä¸Šçº¿ï¼Œé¿å…å¶å‘æ–­çº¿å¯¼è‡´å…¶ä»–ç©å®¶æ— æ³•åŠ å…¥
          setTimeout(()=>db.goOnline(), 800);
          forceReconnect("auto");
        } else if(val){
          // é‡æ–°è¿æ¥æ—¶ï¼Œç¡®ä¿æˆ¿é—´è®¢é˜…è¢«æ¢å¤
          reattachRoomListener();
        }
        if(val && roomId && playerSeat !== null){
          db.ref(`rooms/${roomId}/players/${playerSeat}`).update({ online:true, lastSeen: Date.now() });
          setupHeartbeat();
        }
      });
    }

    function reattachRoomListener(){
      if(roomRefCurrent && roomSnapshotHandler){
        roomRefCurrent.off("value", roomSnapshotHandler);
        roomRefCurrent.on("value", roomSnapshotHandler, roomErrorHandler || undefined);
      }
    }

    function initPlayerMode(){
      const rid=getQueryParam("room") || roomId;
      if(!rid){
        $("playerRoomLabel").textContent="æœªæŒ‡å®šæˆ¿é—´ï¼›è¯·ä½¿ç”¨æˆ¿ä¸»çš„é“¾æ¥ï¼Œæˆ–åœ¨ä¸»é¡µè¾“å…¥æˆ¿é—´å·åŠ å…¥ã€‚";
        $("playerCardView").innerHTML="é“¾æ¥æ— æ•ˆæˆ–æœªåˆ›å»ºæˆ¿é—´ã€‚";
        return;
      }
      roomId = rid;
      $("playerRoomLabel").textContent=`æˆ¿é—´ï¼š${rid} Â· åº§ä½ï¼šè§‚æˆ˜ä¸­`;

      setupConnectionWatch();

      const nickInput = $("nicknameInput");
      if(nickInput){
        nickInput.value = localNickname;
      }

      // åˆ†äº«é“¾æ¥
      const origin=location.origin+location.pathname;
      const baseUrl=`${origin}?room=${encodeURIComponent(rid)}`;
      $("shareLinkBoxPlayer").innerHTML =
        `<code>${baseUrl}</code><br>æŠŠè¿™æ¡é“¾æ¥å‘ç»™å…¶ä»–ç©å®¶ï¼Œè®©ä»–ä»¬åŠ å…¥å¹¶é€‰æ‹©åº§ä½ã€‚`;

      const roomRef=db.ref("rooms/"+rid);
      roomRefCurrent = roomRef;

      const handleRoomError = (err) => {
        console.error("è¯»å–æˆ¿é—´æ•°æ®å¤±è´¥:", err);
        updateConnectionStatusUI(false);
        $("playerCardView").innerHTML =
          "è¿æ¥æˆ¿é—´æ—¶å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–ç¨åé‡è¯•ã€‚<br><small>å¦‚æœå¤šå°è®¾å¤‡éƒ½è¿™æ ·ï¼Œæ£€æŸ¥ä¸€ä¸‹ Firebase Realtime Database çš„è§„åˆ™æ˜¯å¦å…è®¸è¯»å†™ã€‚</small>";
        $("playerInfoText").textContent = "æˆ¿é—´æ•°æ®æš‚æ—¶æ— æ³•è¯»å–ï¼Œè¯·ç¨åé‡è¯•ã€‚";
        renderSeatList([], 0, null);
        // é‡åˆ°é”™è¯¯æ—¶å°è¯•é‡æ–°è®¢é˜…
        setTimeout(reattachRoomListener, 600);
      };

      const handleRoomSnapshot = (snap) => {
        try{
          const val=snap.val();
          latestRoomData = val;
          if(!val){
            $("playerCardView").innerHTML="æˆ¿é—´ä¸å­˜åœ¨æˆ–æœªåˆ›å»ºã€‚";
            $("playerInfoText").textContent="è¯·ç¡®è®¤æˆ¿é—´å·æ˜¯å¦æ­£ç¡®ï¼Œæˆ–ç­‰å¾…æˆ¿ä¸»åˆ›å»ºæˆ¿é—´ã€‚";
            $("orderOverlay").style.display="none";
            $("ordersSummaryPlayer").textContent="å½“å‰è¿˜æ²¡æœ‰è®¢å•ã€‚";
            $("ordersListPlayer").innerHTML="";
            $("othersInvCard").style.display="none";
            return;
          }
          const players = val.players || [];
          const pc = val.playerCount || players.length || 0;
          const hostSeatVal = typeof val.hostSeat === "number" ? val.hostSeat : null;

          // æ¸²æŸ“åº§ä½åˆ—è¡¨ï¼ˆç‚¹å‡»åŠ å…¥ / ç¦»å¼€ï¼‰
          renderSeatList(players, pc, hostSeatVal);
          syncHostClientFlag(hostSeatVal);

          const g=val.game || {};
          const started = !!g.started;
          const info=g.infoText || (started ? "æ¸¸æˆè¿›è¡Œä¸­â€¦" : "ç­‰å¾…æˆ¿ä¸»å¼€å§‹æ¸¸æˆâ€¦");
          $("playerInfoText").innerHTML=info;

          // === è‡ªå·±çš„æ€»ä½“ä¿¡æ¯ï¼ˆä¸çœ‹åº“å­˜å†…å®¹ï¼‰ + å…¶ä»–ç©å®¶å¡ç‰‡ ===
          let invCardText = "";
          const othersInvCard = $("othersInvCard");
          const othersInvList = $("othersInvList");
          const othersInvTitle = $("othersInvTitle");
          const roundEnded = !!(g.canStartNextRound || g.gameOver);

          if(playerSeat !== null){
            const me = players[playerSeat];
            const name = me && me.name ? me.name : ("ç©å®¶" + (playerSeat + 1));
            const inv = me && me.inventory;
            const angerVal = me && typeof me.anger === "number" ? me.anger : 0;
            const isHostSeatMe = (hostSeatVal === playerSeat);
            const hostTag = isHostSeatMe ? "ï¼ˆğŸ‘‘ æˆ¿ä¸»ï¼‰" : "";

            let selfInvLine = "";
            if (!inv) {
              selfInvLine = "æœ¬å±€åº“å­˜ç‰Œå°šæœªå‘æ”¾æˆ–å°šæœªå¼€å§‹ã€‚";
            } else {
              if (roundEnded) {
                const desc = describeInventoryCardShort(inv);
                selfInvLine = `æœ¬å±€åº“å­˜ï¼š${desc}<br><small>ï¼ˆç»“ç®—é˜¶æ®µå¯å¤ç›˜æŸ¥çœ‹ï¼›ä¸‹ä¸€å±€å‘æ–°ç‰Œåå°†è‡ªåŠ¨éšè—ï¼‰</small>`;
              } else {
                selfInvLine = describeInventoryCardForSelf(inv);
              }
            }

            invCardText =
              `${name}${hostTag}<br><br>` +
              selfInvLine +
              `<br><br><small>ä½ çš„æ„¤æ€’å€¼ï¼š${angerVal} / ${ANGER_LIMIT}</small>`;

            $("playerRoomLabel").textContent =
              `æˆ¿é—´ï¼š${rid} Â· åº§ä½ï¼š${playerSeat + 1}${isHostSeatMe ? " Â· æˆ¿ä¸»" : ""}`;

            // === å…¶ä»–ç©å®¶åº“å­˜ï¼šå•ç‹¬å¡ç‰‡ ===
            const otherCards = [];
            for (let i = 0; i < pc; i++) {
              if (i === playerSeat) continue;
              const p = players[i];
              const pName = p && p.name ? p.name : ("ç©å®¶" + (i + 1));
              const pInv = p && p.inventory;
              const pAnger = p && typeof p.anger === "number" ? p.anger : 0;
              const isHost = (hostSeatVal === i);

              let desc = "å°šæœªå‘ç‰Œ";
              if (pInv) desc = describeInventoryCardShort(pInv);
              else if (!p) desc = "åº§ä½æš‚æ— ç©å®¶";

              const html = `
                <div class="other-player-card">
                  <div class="other-player-title">
                    åº§ä½ ${i + 1}${isHost ? " ğŸ‘‘æˆ¿ä¸»" : ""}ï¼š${pName}
                  </div>
                  <div class="other-player-meta">
                    åº“å­˜ï¼š${desc}<br>
                    æ„¤æ€’å€¼ï¼š${pAnger} / ${ANGER_LIMIT}
                  </div>
                </div>
              `;
              otherCards.push(html);
            }

            othersInvTitle.textContent = "å…¶ä»–ç©å®¶åº“å­˜";
            if (otherCards.length > 0) {
              othersInvList.innerHTML = otherCards.join("");
            } else {
              othersInvList.innerHTML = "<div style=\"font-size:12px;color:#999;\">å½“å‰æ²¡æœ‰å¯å±•ç¤ºçš„å…¶ä»–ç©å®¶åº“å­˜ã€‚</div>";
            }
            othersInvCard.style.display = "block";

          } else {
            // è§‚æˆ˜æ¨¡å¼ï¼šæŸ¥çœ‹æ‰€æœ‰ç©å®¶åº“å­˜
            const allCards = [];
            for (let i = 0; i < pc; i++) {
              const p = players[i];
              const pName = p && p.name ? p.name : ("ç©å®¶" + (i + 1));
              const pInv = p && p.inventory;
              const pAnger = p && typeof p.anger === "number" ? p.anger : 0;
              const isHost = (hostSeatVal === i);

              let desc;
              if (!pInv) desc = p ? "å°šæœªå‘ç‰Œ" : "åº§ä½æš‚æ— ç©å®¶";
              else desc = describeInventoryCardShort(pInv);

              const html = `
                <div class="other-player-card">
                  <div class="other-player-title">
                    åº§ä½ ${i + 1}${isHost ? " ğŸ‘‘æˆ¿ä¸»" : ""}ï¼š${pName}
                  </div>
                  <div class="other-player-meta">
                    åº“å­˜ï¼š${desc}<br>
                    æ„¤æ€’å€¼ï¼š${pAnger} / ${ANGER_LIMIT}
                  </div>
                </div>
              `;
              allCards.push(html);
            }

            invCardText =
              "ä½ å½“å‰ä¸ºè§‚æˆ˜æ¨¡å¼ï¼Œå¯éšæ—¶æŸ¥çœ‹æ‰€æœ‰ç©å®¶åº“å­˜ä¿¡æ¯ã€‚";

            $("playerRoomLabel").textContent = `æˆ¿é—´ï¼š${rid} Â· åº§ä½ï¼šè§‚æˆ˜ä¸­`;

            othersInvTitle.textContent = "æ‰€æœ‰ç©å®¶åº“å­˜";
            if (allCards.length > 0) {
              othersInvList.innerHTML = allCards.join("");
            } else {
              othersInvList.innerHTML = "<div style=\"font-size:12px;color:#999;\">æš‚æ— ç©å®¶æˆ–æš‚ä¸å¯ç”¨çš„åº“å­˜ä¿¡æ¯ã€‚</div>";
            }
            othersInvCard.style.display = "block";
          }

          $("playerCardView").innerHTML = invCardText;

          const gameOverFlag = !!g.gameOver;
          const isMyTurn = (g.currentPlayer===playerSeat);

          // è§‚æˆ˜æ¨¡å¼æˆ–æœªå¼€å§‹æ—¶ä¸èƒ½æ“ä½œ
          if($("pDrawBtn")){
            $("pDrawBtn").disabled = (playerSeat===null || !isMyTurn || gameOverFlag || !started);
          }
          if($("pBellBtn")){
            $("pBellBtn").disabled = (playerSeat===null || gameOverFlag || !started);
          }
          if($("pNextBtn")){
            $("pNextBtn").disabled = (playerSeat===null || gameOverFlag || !started);
          }

          // ç»“ç®—åŒºï¼šç©å®¶ä¹Ÿæ˜¾ç¤ºå½“å‰è®¢å•
          const ordersArr = g.orders || [];
          const sumEl = $("ordersSummaryPlayer");
          const listEl = $("ordersListPlayer");
          if(sumEl && listEl){
            if(ordersArr.length===0){
              sumEl.textContent = "å½“å‰è¿˜æ²¡æœ‰è®¢å•ã€‚";
              listEl.innerHTML = "";
            }else{
              const totals={grape:0,strawberry:0,banana:0,durian:0};
              ordersArr.forEach(o=>{
                if(!o || !o.fruitKey) return;
                if(!(o.fruitKey in totals)) return;
                totals[o.fruitKey]+=o.amount||0;
              });
              const frags=[];
              FRUITS.forEach(f=>{
                frags.push(`<span>${f.emoji}${f.label}ï¼š${totals[f.key]}</span>`);
              });
              sumEl.innerHTML = frags.join("");
              listEl.innerHTML = "";
              ordersArr.forEach(o=>{
                const f=FRUITS.find(x=>x.key===o.fruitKey);
                const nm = players[o.by] && players[o.by].name ? players[o.by].name : ("ç©å®¶"+( (o.by||0)+1 ));
                const div=document.createElement("div");
                div.className="order-card";
                const icon=document.createElement("span");
                icon.textContent=f?f.emoji:"?";
                const t=document.createElement("span");
                t.textContent=`${f?f.label:"æ°´æœ"} Ã— ${o.amount||0}ï¼ˆ${nm}ï¼‰`;
                div.appendChild(icon);div.appendChild(t);
                listEl.appendChild(div);
              });
            }
          }

          // å¦‚æœè½®åˆ°æˆ‘é€‰è®¢å•ï¼Œå¼¹çª—
          const pending = g.pendingOrder;
          if(started && pending && pending.by === playerSeat && pending.awaitingChoice){
            const fruitA = FRUITS.find(f=>f.key===pending.optionA.fruitKey);
            const fruitB = FRUITS.find(f=>f.key===pending.optionB.fruitKey);
            $("orderOverlayTitle").textContent = "ä½ æ‘¸åˆ°ä¸¤ç§è®¢å•ï¼Œé€‰æ‹©å…¶ä¸€ï¼š";
            $("orderOptAEmoji").textContent = fruitA ? fruitA.emoji : "A";
            $("orderOptAText").textContent = (fruitA ? fruitA.label : "æ°´æœ") + " Ã— " + pending.optionA.amount;
            $("orderOptBEmoji").textContent = fruitB ? fruitB.emoji : "B";
            $("orderOptBText").textContent = (fruitB ? fruitB.label : "æ°´æœ") + " Ã— " + pending.optionB.amount;
            $("orderOverlay").style.display = "flex";
          }else{
            $("orderOverlay").style.display = "none";
          }
        }catch(e){
          console.error("æˆ¿é—´æ•°æ®å¤„ç†å‡ºé”™:", e);
          handleRoomError(e);
        }
      };

      roomSnapshotHandler = handleRoomSnapshot;
      roomErrorHandler = handleRoomError;
      roomRef.on("value", handleRoomSnapshot, handleRoomError);
      roomRef.once("value").then(handleRoomSnapshot).catch(handleRoomError);
    }

    // è‡ªåŠ¨æ¢åº§ï¼šç‚¹å‡»æ–°åº§ä½ï¼ŒåŸåº§ä½è‡ªåŠ¨ä¸‹çº¿ï¼›å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œæˆ¿ä¸»èº«ä»½è·Ÿéšåº§ä½ç§»åŠ¨
    function joinSeat(seatIdx){
      if (!latestRoomData || !roomId) return;
      const players = latestRoomData.players || [];
      const target = players[seatIdx] || {};
      const count = latestRoomData.playerCount || players.length || 0;

      const oldSeat = playerSeat;
      const updates = {};

      // ç›®æ ‡åº§ä½å·²è¢«å…¶ä»–è®¾å¤‡å ç”¨æ—¶ä¸å…è®¸æŠ¢åº§
      if (target.online && oldSeat !== seatIdx) {
        alert("è¯¥åº§ä½å·²æœ‰ç©å®¶åœ¨çº¿ï¼Œè¯·é€‰æ‹©å…¶ä»–åº§ä½æˆ–ç»§ç»­è§‚æˆ˜ã€‚");
        return;
      }

      // åŸåº§ä½è‡ªåŠ¨ä¸‹çº¿
      if (oldSeat !== null && oldSeat !== seatIdx) {
        updates[`players/${oldSeat}/online`] = false;
        if(latestRoomData.players && latestRoomData.players[oldSeat]){
          latestRoomData.players[oldSeat].online = false;
        }
      }

      // æ–°åº§ä½ä¸Šçº¿å¹¶æ›´æ–°åå­—
      playerSeat = seatIdx;
      const nameToUse = localNickname || target.name || ("ç©å®¶" + (seatIdx + 1));
      updates[`players/${seatIdx}/online`] = true;
      updates[`players/${seatIdx}/name`] = nameToUse;
      updates[`players/${seatIdx}/lastSeen`] = Date.now();

      if(!latestRoomData.players) latestRoomData.players = [];
      latestRoomData.players[seatIdx] = {
        ...target,
        name: nameToUse,
        online: true,
        lastSeen: Date.now()
      };

      if(seatOnlineRef){
        seatOnlineRef.onDisconnect().cancel();
      }
      seatOnlineRef = db.ref(`rooms/${roomId}/players/${seatIdx}/online`);
      seatOnlineRef.onDisconnect().set(false);
      setupHeartbeat();

      const nextHostSeatVal = updates["hostSeat"] ?? latestRoomData.hostSeat;
      renderSeatList(latestRoomData.players || [], count, nextHostSeatVal);
      syncHostClientFlag(nextHostSeatVal);

      // æˆ¿ä¸»é€»è¾‘ï¼šæˆ¿ä¸»æ¢åº§ï¼Œæˆ¿ä¸»èº«ä»½è·Ÿç€è¿™ä¸ªç©å®¶
      const currentHostSeat = latestRoomData.hostSeat;
      const hasHostSeat = typeof currentHostSeat === "number";
      const iWasHostBeforeMove =
        hasHostSeat && oldSeat !== null && currentHostSeat === oldSeat;

      if (!hasHostSeat && isHostClient) {
        // æˆ¿é—´è¿˜æ²¡æŒ‡å®šæˆ¿ä¸»åº§ä½ï¼Œä¸”è¿™æ˜¯åˆ›å»ºæˆ¿é—´çš„è®¾å¤‡ç¬¬ä¸€æ¬¡å…¥åº§
        updates["hostSeat"] = seatIdx;
      } else if (iWasHostBeforeMove) {
        // æˆ‘åŸæ¥å°±æ˜¯æˆ¿ä¸»ï¼Œæ¢ä½ä¹‹åæˆ¿ä¸»è·Ÿç€æˆ‘
        updates["hostSeat"] = seatIdx;
      }

      db.ref("rooms/" + roomId).update(updates);

      $("playerRoomLabel").textContent = `æˆ¿é—´ï¼š${roomId} Â· åº§ä½ï¼š${seatIdx + 1}`;
    }

    // ç¦»å¼€åº§ä½ï¼Œå›åˆ°è§‚æˆ˜æ¨¡å¼ï¼›å¦‚æœç¦»å¼€çš„æ˜¯æˆ¿ä¸»åº§ä½ï¼Œåˆ™éšæœºä¸€ä¸ªåœ¨çº¿ç©å®¶æˆä¸ºæ–°æˆ¿ä¸»
    function leaveSeat(){
      if(!latestRoomData || !roomId) return;
      if(playerSeat===null) return;
      const seatIdx = playerSeat;
      if(seatOnlineRef){
        seatOnlineRef.onDisconnect().cancel();
        seatOnlineRef = null;
      }
      if(heartbeatTimer){
        clearInterval(heartbeatTimer);
        heartbeatTimer = null;
      }
      db.ref("rooms/"+roomId+"/players/"+seatIdx).update({ online:false, lastSeen:Date.now() });

      let currentHostSeat = latestRoomData.hostSeat;
      let nextHostSeatVal = currentHostSeat;
      if(latestRoomData && latestRoomData.players && latestRoomData.players[seatIdx]){
        latestRoomData.players[seatIdx].online = false;
        latestRoomData.players[seatIdx].lastSeen = Date.now();
      }

      if(isHostClient && currentHostSeat === seatIdx){
        const players = latestRoomData.players || [];
        const candidates = [];
        for(let i=0;i<players.length;i++){
          if(i===seatIdx) continue;
          if(players[i] && players[i].online) candidates.push(i);
        }
        let newHost = null;
        if(candidates.length>0){
          newHost = candidates[randomInt(0,candidates.length-1)];
        }
        db.ref("rooms/"+roomId+"/hostSeat").set(newHost);
        nextHostSeatVal = newHost;
      }

      playerSeat = null;
      renderSeatList(
        (latestRoomData && latestRoomData.players) ? latestRoomData.players : [],
        (latestRoomData && (latestRoomData.playerCount || (latestRoomData.players || []).length)) || 0,
        nextHostSeatVal
      );
      $("playerRoomLabel").textContent=`æˆ¿é—´ï¼š${roomId} Â· åº§ä½ï¼šè§‚æˆ˜ä¸­`;
      isHostClient = false;
      updateHostControlCardVisibility();
    }

    function enqueueActionPlayer(type){
      if(!roomId || playerSeat===null || !db) return;
      const refActions=db.ref("rooms/"+roomId+"/actions");
      refActions.push({
        type, seat:playerSeat, ts:Date.now(), processed:false
      });
    }

    function playerDrawClick(){
      enqueueActionPlayer("draw");
    }
    function playerBellClick(){
      enqueueActionPlayer("bell");
    }
    function playerNextRoundClick(){
      enqueueActionPlayer("nextRound");
    }

    function playerChooseOrder(side){
      if(!roomId || playerSeat===null) return;
      const type = side === "A" ? "chooseA" : "chooseB";
      const refActions = db.ref("rooms/"+roomId+"/actions");
      refActions.push({
        type,
        seat: playerSeat,
        ts: Date.now(),
        processed: false
      });
      $("orderOverlay").style.display = "none";
    }

    // é€šè¿‡æˆ¿é—´å·åŠ å…¥ï¼ˆä¸ç”¨é“¾æ¥ï¼‰
    function joinRoomByCode(){
      const rid = $("joinRoomInput").value.trim();
      if(!rid){
        alert("è¯·å…ˆè¾“å…¥æˆ¿é—´å·");
        return;
      }
      const url = new URL(window.location.href);
      url.searchParams.set("room", rid);
      url.searchParams.delete("mode");
      window.history.replaceState({}, "", url.toString());
      toggleToPlayerMode();
      initPlayerMode();
    }

    // ====== æ¨¡å¼åˆ‡æ¢ä¸æ˜µç§° ======
    function toggleToHostMode(){
      $("hostRoot").style.display="flex";
      $("playerRoot").style.display="none";
    }
    function toggleToPlayerMode(){
      $("hostRoot").style.display="none";
      $("playerRoot").style.display="flex";
      updateHostControlCardVisibility();
    }

    function toggleRules(force){
      rulesOpen = typeof force === "boolean" ? force : !rulesOpen;
      const panel = $("rulesPanel");
      const btn = $("rulesToggleBtn");
      if(panel){
        panel.style.display = rulesOpen ? "block" : "none";
      }
      if(btn){
        btn.textContent = rulesOpen ? "ğŸ“˜ æ”¶èµ·è§„åˆ™" : "ğŸ“˜ æŸ¥çœ‹è§„åˆ™";
      }
    }

    window.addEventListener("beforeunload", ()=>{
      if(seatOnlineRef){
        seatOnlineRef.onDisconnect().cancel();
      }
      if(roomId && playerSeat!==null){
        db.ref(`rooms/${roomId}/players/${playerSeat}/online`).set(false);
      }
      if(heartbeatTimer){
        clearInterval(heartbeatTimer);
        heartbeatTimer=null;
      }
    });

    function saveNickname(){
      const input = $("nicknameInput");
      if(!input) return;
      const val = input.value.trim();
      localNickname = val;
      localStorage.setItem("llwfNickname", val);
      if(roomId && playerSeat !== null){
        const ref = db.ref(`rooms/${roomId}/players/${playerSeat}/name`);
        ref.set(val || ("ç©å®¶" + (playerSeat + 1)));
      }
    }

    function setupHeartbeat(){
      if(!roomId || playerSeat === null) return;
      if(heartbeatTimer) clearInterval(heartbeatTimer);
      heartbeatTimer = setInterval(()=>{
        db.ref(`rooms/${roomId}/players/${playerSeat}/lastSeen`).set(Date.now());
      }, 15000);
    }

    window.onload=function(){
      toggleRules(false);
      const roomParam=getQueryParam("room");
      const mode=getQueryParam("mode");
      // æœ‰ room å‚æ•°ï¼ˆä¸”æ²¡å¼ºåˆ¶ mode=hostï¼‰å°±é»˜è®¤å½“ç©å®¶åŠ å…¥æˆ¿é—´
      if(roomParam && mode!=="host"){
        toggleToPlayerMode();
        initPlayerMode();
      }else{
        toggleToHostMode();
        $("infoBox").innerHTML="å¯ä»¥åœ¨è¿™é‡Œåˆ›å»ºæˆ¿é—´ï¼›ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹é€šè¿‡è¾“å…¥æˆ¿é—´å·åŠ å…¥å·²æœ‰æˆ¿é—´ã€‚æˆ¿é—´å»ºç«‹åï¼Œåº§ä½åæ»¡å¹¶ç‚¹å‡»ã€Œå¼€å§‹æ¸¸æˆã€åæ‰ä¼šå‘ç‰Œã€‚";
      }
    };
  </script>
</body>
</html>
