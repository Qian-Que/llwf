<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ¦´è²å¿˜è´© Â· åœ¨çº¿æˆ¿é—´ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <!-- Firebase v9 compat ç‰ˆ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: #fefaf3;
      color: #333;
    }
    .root {
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    h1 {
      font-size: 20px;
      text-align: center;
      margin: 6px 0;
    }
    .subtitle {
      font-size: 12px;
      text-align: center;
      color: #888;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #ffb14a;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 2px 0 #d27a25;
      transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.2s;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 0 #d27a25;
    }
    .btn.secondary {
      background: #fff;
      color: #666;
      box-shadow: 0 2px 0 #d0d0d0;
      border: 1px solid #ddd;
    }
    .btn.small {
      padding: 3px 8px;
      font-size: 11px;
      box-shadow: 0 1px 0 #d27a25;
    }
    .btn:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .row.center {
      justify-content: center;
    }
    input, select {
      border-radius: 8px;
      border: 1px solid #ffd799;
      padding: 4px 6px;
      font-size: 14px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #ffe2a4;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      padding: 8px;
      font-size: 13px;
    }
    .players {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .player-card {
      flex: 1 1 calc(50% - 4px);
      background: #fff8e6;
      border-radius: 12px;
      padding: 8px;
      border: 1px solid #ffe2a4;
      font-size: 12px;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .player-card.active {
      border-color: #ff9b3d;
      box-shadow: 0 0 0 2px rgba(255,155,61,0.3);
    }
    .player-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }
    .badge-round {
      font-size: 11px;
      background: #fff;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #ffd1a3;
      color: #c45b16;
    }
    .anger-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #ffe3d6;
      overflow: hidden;
    }
    .anger-fill {
      height: 100%;
      background: linear-gradient(90deg, #ffa25b, #ff4b4b);
      width: 0%;
      transition: width 0.2s;
    }
    .orders-panel {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .orders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    .orders-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 12px;
    }
    .orders-summary span {
      padding: 2px 6px;
      border-radius: 999px;
      background: #fff8e6;
      border: 1px solid #ffe0af;
    }
    .orders-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      max-height: 120px;
      overflow-y: auto;
    }
    .order-card {
      background: #fffceb;
      border-radius: 8px;
      padding: 3px 6px;
      font-size: 11px;
      border: 1px solid #ffe2a4;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .info-box {
      font-size: 13px;
      background: #fff;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid #f0d9ff;
      color: #555;
      line-height: 1.4;
    }
    .link-box {
      font-size: 12px;
      background: #fff;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px dashed #ffd1a3;
      line-height: 1.5;
      word-break: break-all;
    }

    /* ç©å®¶æ‰‹æœºæ¨¡å¼ */
    .player-root {
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 10px;
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    .big-card {
      font-size: 18px;
      background: #fff8e6;
      border-radius: 16px;
      border: 1px solid #ffdba0;
      padding: 16px;
      text-align: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    }
    .big-card small {
      display: block;
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .overlay-inner {
      background: #fffdf7;
      border-radius: 12px;
      padding: 12px;
      width: 90%;
      max-width: 360px;
      border: 1px solid #ffdca0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      font-size: 13px;
    }
    .overlay-title {
      font-weight: 600;
      margin-bottom: 6px;
    }
    .fruit-choice-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      justify-content: center;
    }
    .fruit-chip {
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid #ffd1a3;
      background: #fff;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .fruit-chip span {
      font-size: 14px;
    }

    /* ç©å®¶çŠ¶æ€å¡ç‰‡ï¼ˆæ‰‹æœºç«¯ï¼‰ */
    .p-player-row {
      margin-bottom: 6px;
      font-size: 12px;
    }
    .p-player-name {
      margin-bottom: 2px;
    }
    .p-player-anger-text {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <!-- ä¸»æœºæ¨¡å¼ -->
  <div class="root" id="hostRoot">
    <h1>æ¦´è²å¿˜è´© Â· åœ¨çº¿ä¸»æœº</h1>
    <div class="subtitle" id="roomInfoSubtitle">æœªåˆ›å»ºæˆ¿é—´</div>

    <div class="card" id="hostSetupCard">
      <div style="margin-bottom:6px;">åˆ›å»ºæˆ¿é—´</div>
      <div class="row" style="margin-bottom:4px;">
        <label>æˆ¿é—´å·ï¼š
          <input id="roomIdInput" style="width:100px;" placeholder="å¦‚ 1234" />
        </label>
        <button class="btn small" onclick="genRandomRoomId()">éšæœº</button>
      </div>
      <div style="margin-bottom:4px;">
        ç©å®¶äººæ•°ï¼š
        <select id="hostPlayerCount">
          <option value="2">2 äºº</option>
          <option value="3">3 äºº</option>
          <option value="4">4 äºº</option>
        </select>
      </div>
      <div style="font-size:12px;margin-bottom:4px;">å¯é€‰ï¼šä¸ºæ¯ä¸ªåº§ä½å¡«æ˜µç§°ï¼Œæ–¹ä¾¿è¾¨è®¤ã€‚</div>
      <div id="hostNameInputs" style="display:flex;flex-direction:column;gap:4px;margin-bottom:6px;">
        <input id="hostName0" placeholder="ç©å®¶1æ˜µç§°ï¼ˆå¯é€‰ï¼‰" />
        <input id="hostName1" placeholder="ç©å®¶2æ˜µç§°ï¼ˆå¯é€‰ï¼‰" />
        <input id="hostName2" placeholder="ç©å®¶3æ˜µç§°ï¼ˆå¯é€‰ï¼‰" />
        <input id="hostName3" placeholder="ç©å®¶4æ˜µç§°ï¼ˆå¯é€‰ï¼‰" />
      </div>
      <button class="btn" onclick="createRoom()">åˆ›å»ºæˆ¿é—´å¹¶å¼€å§‹æ¸¸æˆ</button>
    </div>

    <div class="card" id="joinLinksCard" style="display:none;">
      <div style="margin-bottom:4px;">ç©å®¶åŠ å…¥é“¾æ¥ï¼ˆå‘ç»™æœ‹å‹ï¼‰</div>
      <div id="joinLinksBox" class="link-box"></div>
    </div>

    <div class="card" id="playersCard" style="display:none;">
      <div class="players" id="playersContainer"></div>
    </div>

    <div class="card" id="controlCard" style="display:none;">
      <div class="row center" style="margin-bottom:6px;">
        <button class="btn" id="drawBtn" onclick="hostDrawClick()">ğŸ‰ æ‘¸ç‰Œå¹¶ä¸‹è®¢å•</button>
        <button class="btn secondary" id="bellBtn" onclick="hostBellClick()">ğŸ”” æ‘‡é“ƒè´¨ç–‘</button>
        <button class="btn secondary" onclick="resetGame()">é‡ç½®æ•´åœº</button>
        <button class="btn secondary" id="nextRoundBtn" onclick="hostNextRoundClick()" disabled>â¡ï¸ ä¸‹ä¸€å›åˆ</button>
      </div>
      <div class="orders-panel">
        <div class="orders-header">
          <span>è®¢å•åŒº</span>
          <span>æœ€åä¸‹å•ï¼š<strong id="lastOrderPlayerLabel">æš‚æ— </strong></span>
        </div>
        <div class="orders-summary" id="ordersSummary">
          å½“å‰è¿˜æ²¡æœ‰è®¢å•ã€‚
        </div>
        <div class="orders-list" id="ordersList"></div>
      </div>
    </div>

    <div class="info-box" id="infoBox">
      åœ¨ä¸Šæ–¹åˆ›å»ºæˆ¿é—´ã€‚
    </div>
  </div>

  <!-- ç©å®¶æ¨¡å¼ -->
  <div class="player-root" id="playerRoot">
    <h1>æ¦´è²å¿˜è´© Â· ç©å®¶è§†è§’</h1>
    <div class="subtitle" id="playerRoomLabel">æˆ¿é—´ï¼šâ€” åº§ä½ï¼šâ€”</div>

    <div class="big-card" id="playerCardView">
      æ­£åœ¨è¿æ¥æˆ¿é—´â€¦
      <small>è¯·ç¡®è®¤é“¾æ¥æ­£ç¡®ï¼Œä¸”ä¸»æœºå·²åˆ›å»ºæˆ¿é—´ã€‚</small>
    </div>

    <div class="card">
      <div id="playerInfoText" style="font-size:13px;">
        ç­‰å¾…ä¸»æœºå¼€å§‹æ¸¸æˆâ€¦
      </div>
    </div>

    <!-- ç©å®¶çŠ¶æ€ï¼šæ„¤æ€’å€¼æ¡ï¼ˆæ‰‹æœºç«¯ï¼‰ -->
    <div class="card">
      <div style="font-size:13px;margin-bottom:4px;">ç©å®¶çŠ¶æ€</div>
      <div id="pPlayersContainer"></div>
    </div>

    <!-- ç©å®¶ä¹Ÿèƒ½çœ‹åˆ°è®¢å•åŒºï¼ˆåªè¯»ï¼‰ -->
    <div class="card">
      <div style="font-size:13px;margin-bottom:4px;">è®¢å•åŒº</div>
      <div class="orders-summary" id="pOrdersSummary">å½“å‰è¿˜æ²¡æœ‰è®¢å•ã€‚</div>
      <div class="orders-list" id="pOrdersList"></div>
    </div>

    <div class="card">
      <div style="font-size:13px;margin-bottom:6px;">æ“ä½œ</div>
      <div class="row center">
        <button class="btn" id="pDrawBtn" onclick="playerDrawClick()">ğŸ‰ æ‘¸ç‰Œ</button>
        <button class="btn secondary" id="pBellBtn" onclick="playerBellClick()">ğŸ”” æ‘‡é“ƒ</button>
        <button class="btn secondary" id="pNextBtn" onclick="playerNextRoundClick()">â¡ï¸ ä¸‹ä¸€å›åˆ</button>
        <button class="btn secondary" id="pResetBtn" onclick="playerResetClick()">ğŸ§¹ é‡ç½®æ•´åœº</button>
      </div>
      <div style="font-size:11px;color:#999;margin-top:4px;">
        æ‘¸ç‰Œï¼šä»…åœ¨è½®åˆ°ä½ æ—¶æœ‰æ•ˆï¼›æ‘‡é“ƒ / ä¸‹ä¸€å›åˆ / é‡ç½®æ•´åœºï¼šä»»ä½•äººéƒ½å¯æŒ‰ï¼Œç”±ä¸»æœºæ‰§è¡Œã€‚
      </div>
      <div style="font-size:11px;color:#777;margin-top:6px;text-align:center;">
        æƒ³è‡ªå·±å½“ä¸»æœºï¼Ÿ<button class="btn small" onclick="gotoHostMode()">æˆ‘è¦åˆ›å»ºæ–°æˆ¿é—´</button>
      </div>
    </div>
  </div>

  <!-- åŒæ°´æœäºŒé€‰ä¸€å¼¹çª—ï¼ˆåªç»™å½“å‰æ‘¸ç‰Œç©å®¶æ‰‹æœºç”¨ï¼‰ -->
  <div class="overlay" id="orderOverlay">
    <div class="overlay-inner">
      <div class="overlay-title" id="orderOverlayTitle">é€‰æ‹©è¦ä¸‹å•çš„æ°´æœ</div>
      <div>ä»ä¸‹é¢ä¸¤ç§æ°´æœä¸­é€‰æ‹©ä¸€ç§åŠ å…¥è®¢å•åŒºã€‚</div>
      <div class="fruit-choice-row">
        <div class="fruit-chip" onclick="playerChooseOrder('A')">
          <span id="orderOptAEmoji">ğŸ‡</span>
          <span id="orderOptAText">è‘¡è„ Ã— 2</span>
        </div>
        <div class="fruit-chip" onclick="playerChooseOrder('B')">
          <span id="orderOptBEmoji">ğŸ“</span>
          <span id="orderOptBText">è‰è“ Ã— 1</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== æ›¿æ¢æˆä½ è‡ªå·±çš„ firebaseConfig ======
    const firebaseConfig = {
  apiKey: "AIzaSyAj_-XDvWzVh82dG2l5W92m94pTGgXb8FI",
  authDomain: "llwf-214bc.firebaseapp.com",
  databaseURL: "https://llwf-214bc-default-rtdb.firebaseio.com",
  projectId: "llwf-214bc",
  storageBucket: "llwf-214bc.firebasestorage.app",
  messagingSenderId: "78615220940",
  appId: "1:78615220940:web:90496b12ed2250072f6869",
  measurementId: "G-6RJTS4WR2T"
   };
    // ===========================================
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function $(id){ return document.getElementById(id); }
    function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function getQueryParam(key){
      const url=new URL(window.location.href);
      return url.searchParams.get(key);
    }

    const FRUITS = [
      { key:"grape", label:"è‘¡è„", emoji:"ğŸ‡" },
      { key:"strawberry", label:"è‰è“", emoji:"ğŸ“" },
      { key:"banana", label:"é¦™è•‰", emoji:"ğŸŒ" },
      { key:"durian", label:"æ¦´è²", emoji:"ğŸˆ" }
    ];
    const ANGER_LIMIT = 8;

    const INVENTORY_BASE_PATTERNS = [
      { grape:1, strawberry:2, banana:0, durian:0 },
      { grape:1, strawberry:3, banana:0, durian:0 },
      { grape:1, strawberry:0, banana:2, durian:0 },
      { grape:0, strawberry:1, banana:2, durian:0 },
      { grape:0, strawberry:0, banana:1, durian:2 },
      { grape:0, strawberry:1, banana:0, durian:2 },
      { grape:1, strawberry:0, banana:0, durian:3 }
    ];
    const INVENTORY_DECK = [];
    for(let i=0;i<4;i++){
      INVENTORY_BASE_PATTERNS.forEach(p=>{
        INVENTORY_DECK.push({
          type:"normal",
          fruits:{grape:p.grape,strawberry:p.strawberry,banana:p.banana,durian:p.durian}
        });
      });
    }
    INVENTORY_DECK.push(
      { type:"zero" },
      { type:"banana_inf", fruits:{grape:0,strawberry:0,banana:0,durian:0} },
      { type:"green_star", fruits:{grape:1,strawberry:1,banana:1,durian:1} }
    );

    function createRandomInventoryCard(){
      const idx=randomInt(0,INVENTORY_DECK.length-1);
      const base=INVENTORY_DECK[idx];
      if(base.type==="zero") return { type:"zero" };
      const fruitsCopy={};
      FRUITS.forEach(f=>{
        fruitsCopy[f.key]=base.fruits && typeof base.fruits[f.key]==="number" ? base.fruits[f.key]:0;
      });
      return { type:base.type, fruits:fruitsCopy };
    }

    function describeInventoryCardShort(card){
      if(!card) return "ï¼ˆæ— ï¼‰";
      if(card.type==="zero") return "0å·å¢¨è²ï¼šå…¨ 0";
      if(card.type==="banana_inf"){
        const parts=[];
        FRUITS.forEach(f=>{
          if(f.key==="banana") parts.push(`${f.emoji}âˆ`);
          else{
            const v=card.fruits && typeof card.fruits[f.key]==="number"?card.fruits[f.key]:0;
            parts.push(`${f.emoji}${v}`);
          }
        });
        return "é¦™è•‰å—å¸Œï¼š" + parts.join(" ");
      }
      if(card.type==="green_star"){
        const parts=[];
        FRUITS.forEach(f=>{
          const v=card.fruits && typeof card.fruits[f.key]==="number"?card.fruits[f.key]:0;
          parts.push(`${f.emoji}${v}`);
        });
        return "3å·ç±³å¥‡ï¼š" + parts.join(" ");
      }
      const parts=[];
      FRUITS.forEach(f=>{
        const v=card.fruits && typeof card.fruits[f.key]==="number"?card.fruits[f.key]:0;
        parts.push(`${f.emoji}${v}`);
      });
      return parts.join(" ");
    }

    // ====== ä¸»æœºç«¯çŠ¶æ€ ======
    let roomId = null;
    let playerCount = 2;
    let hostPlayers = [];
    let inventoryCards = [];
    let lastInventoryCards = null;
    let currentPlayer = 0;
    let roundNumber = 1;
    let roundStartPlayer = 0;
    let orders = [];
    let lastOrderPlayer = null;
    let angerToken = 1;
    let choosingOrder = false;
    let pendingOrder = null;
    let canStartNextRound = false;
    let gameOver = false;
    let actionsRef = null;

    function genRandomRoomId(){
      const id=String(randomInt(1000,9999));
      $("roomIdInput").value=id;
    }

    function createRoom(){
      const rid=$("roomIdInput").value.trim();
      if(!rid){ alert("è¯·å…ˆå¡«æˆ¿é—´å·ï¼ˆæˆ–éšæœºç”Ÿæˆï¼‰"); return; }
      roomId = rid;
      playerCount = parseInt($("hostPlayerCount").value,10)||2;
      hostPlayers = [];
      for(let i=0;i<playerCount;i++){
        const nmEl=$("hostName"+i);
        const nm = nmEl?nmEl.value.trim():"";
        hostPlayers.push({ name:nm||("ç©å®¶"+(i+1)), anger:0 });
      }
      for(let i=playerCount;i<4;i++){
        hostPlayers[i]={ name:"æœªä½¿ç”¨", anger:0 };
      }

      $("roomInfoSubtitle").textContent="æˆ¿é—´ï¼š"+roomId+"ï¼ˆä¸»æœºï¼‰";

      const roomRef=db.ref("rooms/"+roomId);
      roomRef.set({
        createdAt:Date.now(),
        playerCount,
        players: hostPlayers.map((p,idx)=>({
          name:p.name, anger:0, seat:idx, inventory:null
        })),
        game:{
          roundNumber:1,
          currentPlayer:0,
          roundStartPlayer:0,
          orders:[],
          lastOrderPlayer:-1,
          angerToken:1,
          infoText:"æˆ¿ä¸»å·²åˆ›å»ºæˆ¿é—´ï¼Œæ­£åœ¨å‘ç‰Œâ€¦",
          gameOver:false,
          pendingOrder:null
        }
      });

      actionsRef = db.ref("rooms/"+roomId+"/actions");
      actionsRef.remove();
      actionsRef.on("child_added", snap=>{
        const action=snap.val();
        if(!action || action.processed) return;
        handleActionFromQueue(action);
        snap.ref.update({processed:true});
      });

      $("hostSetupCard").style.display="none";
      $("playersCard").style.display="block";
      $("controlCard").style.display="block";
      $("joinLinksCard").style.display="block";
      renderHostPlayers();
      updateAngerUI();
      renderJoinLinks();

      startNewRound(true);
    }

    function renderJoinLinks(){
      if(!roomId) return;
      const origin=location.origin+location.pathname;
      let html="";
      html += "æˆ¿é—´å·ï¼š"+roomId+"<br>";
      html += "æ¯ä½ç©å®¶ç”¨æ‰‹æœºæ‰“å¼€å¯¹åº”é“¾æ¥ï¼š<br>";
      for(let i=0;i<playerCount;i++){
        const url=`${origin}?mode=player&room=${encodeURIComponent(roomId)}&seat=${i}`;
        html += `åº§ä½ ${i+1}ï¼ˆ${hostPlayers[i].name}ï¼‰ï¼š<br><code>${url}</code><br>`;
      }
      $("joinLinksBox").innerHTML=html;
    }

    function renderHostPlayers(){
      const container=$("playersContainer");
      let html="";
      for(let i=0;i<playerCount;i++){
        html += `
          <div class="player-card" id="playerCard${i}">
            <div class="player-title-row">
              <span>${hostPlayers[i].name}ï¼ˆåº§ä½ ${i+1}ï¼‰</span>
              ${i===0?`<span class="badge-round" id="roundBadge">ç¬¬ ${roundNumber} å±€</span>`:""}
            </div>
            <div class="anger-bar"><div class="anger-fill" id="angerFill${i}"></div></div>
          </div>
        `;
      }
      container.innerHTML=html;
    }

    function updateAngerUI(){
      for(let i=0;i<playerCount;i++){
        const fill=$("angerFill"+i);
        if(!fill) continue;
        const v=hostPlayers[i].anger||0;
        const pct=Math.min(v/ANGER_LIMIT,1)*100;
        fill.style.width=pct+"%";
      }
    }

    function updateTurnIndicators(){
      for(let i=0;i<playerCount;i++){
        const card=$("playerCard"+i);
        if(card) card.classList.remove("active");
      }
      const ac=$("playerCard"+currentPlayer);
      if(ac) ac.classList.add("active");
      const rb=$("roundBadge");
      if(rb) rb.textContent="ç¬¬ "+roundNumber+" å±€";
      if(roomId){
        db.ref("rooms/"+roomId+"/game/currentPlayer").set(currentPlayer);
      }
    }

    function clearOrdersUI(){
      $("ordersList").innerHTML="";
      $("ordersSummary").textContent="å½“å‰è¿˜æ²¡æœ‰è®¢å•ã€‚";
      $("lastOrderPlayerLabel").textContent="æš‚æ— ";
    }

    function updateOrdersSummary(effectiveTotals=null){
      if(orders.length===0){
        $("ordersSummary").textContent="å½“å‰è¿˜æ²¡æœ‰è®¢å•ã€‚";
        return;
      }
      const totals=effectiveTotals||(function(){
        const t={grape:0,strawberry:0,banana:0,durian:0};
        orders.forEach(o=>{t[o.fruitKey]+=o.amount;});
        return t;
      })();
      const frags=[];
      FRUITS.forEach(f=>{
        frags.push(`<span>${f.emoji}${f.label}ï¼š${totals[f.key]}</span>`);
      });
      $("ordersSummary").innerHTML=frags.join("");
    }

    function cardsEqual(a,b){
      if(!a||!b) return false;
      if(a.type!==b.type) return false;
      if(a.type==="zero") return true;
      const keys=["grape","strawberry","banana","durian"];
      for(const k of keys){
        const va=a.fruits && typeof a.fruits[k]==="number"?a.fruits[k]:0;
        const vb=b.fruits && typeof b.fruits[k]==="number"?b.fruits[k]:0;
        if(va!==vb) return false;
      }
      return true;
    }

    function dealNewInventories(){
      const newCards=new Array(playerCount);
      for(let i=0;i<playerCount;i++){
        let card;let tries=0;
        do{
          card=createRandomInventoryCard();
          tries++;
        }while(lastInventoryCards && lastInventoryCards[i] && cardsEqual(card,lastInventoryCards[i]) && tries<10);
        newCards[i]=card;
      }
      inventoryCards=newCards;
      if(roomId){
        const updates={};
        inventoryCards.forEach((card,idx)=>{
          updates["players/"+idx+"/inventory"]=card;
        });
        db.ref("rooms/"+roomId).update(updates);
      }
    }

    function startNewRound(initial){
      if(inventoryCards && inventoryCards.length===playerCount){
        lastInventoryCards=inventoryCards.slice();
      }else lastInventoryCards=null;

      orders=[];
      lastOrderPlayer=null;
      pendingOrder=null;
      choosingOrder=false;
      canStartNextRound=false;
      $("nextRoundBtn").disabled=true;
      $("drawBtn").disabled=false;
      $("bellBtn").disabled=false;
      gameOver=false;

      clearOrdersUI();
      dealNewInventories();
      updateOrdersSummary();
      updateTurnIndicators();

      const msg=`ç¬¬ ${roundNumber} å±€å¼€å§‹ã€‚å…ˆæ‰‹ï¼š${hostPlayers[currentPlayer].name}`;
      $("infoBox").innerHTML=msg;
      if(roomId){
        db.ref("rooms/"+roomId+"/game").update({
          roundNumber,
          currentPlayer,
          roundStartPlayer,
          orders:[],
          lastOrderPlayer:-1,
          angerToken,
          infoText:msg,
          gameOver:false,
          pendingOrder:null
        });
      }
    }

    function resetGame(){
      hostPlayers.forEach(p=>p.anger=0);
      angerToken=1;
      roundNumber=1;
      currentPlayer=0;
      roundStartPlayer=0;
      gameOver=false;
      updateAngerUI();
      startNewRound(true);
    }

    // ====== ä¸»æœº actions é˜Ÿåˆ—å¤„ç† ======
    function handleActionFromQueue(action){
      if(!roomId) return;
      const type=action.type;
      const seat=action.seat;

      if(type==="draw"){
        if(seat!==currentPlayer) return;
        performDraw(seat);
      }else if(type==="bell"){
        performRing(seat);
      }else if(type==="nextRound"){
        performNextRound();
      }else if(type==="chooseA" || type==="chooseB"){
        if(!choosingOrder || !pendingOrder) return;
        if(seat !== pendingOrder.by) return;
        const side = type==="chooseA" ? "A" : "B";
        applyOrderChoice(side);
      }else if(type==="resetGame"){
        resetGame();
      }
    }

    function enqueueAction(type,seat){
      if(!roomId || !actionsRef) return;
      actionsRef.push({
        type, seat, ts:Date.now(), processed:false
      });
    }

    function hostDrawClick(){
      if(gameOver || canStartNextRound) return;
      enqueueAction("draw", currentPlayer);
    }
    function hostBellClick(){
      enqueueAction("bell", currentPlayer);
    }
    function hostNextRoundClick(){
      enqueueAction("nextRound", currentPlayer);
    }

    // ====== ä¸»æœºï¼šæ‘¸ç‰Œ & é€‰è®¢å•ç»“ç®—ï¼ˆæ‰‹æœºé€‰ï¼Œä¸»æœºç®—ï¼‰ ======
    function performDraw(seat){
      if(gameOver || canStartNextRound) return;
      if(choosingOrder) return;

      let idxA=randomInt(0,FRUITS.length-1);
      let idxB;
      do{idxB=randomInt(0,FRUITS.length-1);}while(idxB===idxA);
      const fruitA=FRUITS[idxA];
      const fruitB=FRUITS[idxB];

      const maxAmount=(playerCount===2?2:3);
      const amountA=randomInt(1,maxAmount);
      const amountB=randomInt(1,maxAmount);

      pendingOrder={
        by:seat,
        optionA:{fruitKey:fruitA.key,amount:amountA},
        optionB:{fruitKey:fruitB.key,amount:amountB}
      };
      choosingOrder=true;

      if(roomId){
        db.ref("rooms/"+roomId+"/game/pendingOrder").set({
          by: seat,
          optionA: pendingOrder.optionA,
          optionB: pendingOrder.optionB,
          awaitingChoice: true
        });
      }

      const msg=`${hostPlayers[seat].name} æ‘¸ç‰Œï¼šè¯·åœ¨ TA çš„æ‰‹æœºä¸Šé€‰æ‹©è®¢å•ã€‚`;
      $("infoBox").innerHTML=msg;
      if(roomId) db.ref("rooms/"+roomId+"/game/infoText").set(msg);

      $("drawBtn").disabled=true;
      $("bellBtn").disabled=true;
    }

    function applyOrderChoice(side){
      if(!choosingOrder || !pendingOrder || gameOver) return;
      const player=pendingOrder.by;
      const opt=side==="A"?pendingOrder.optionA:pendingOrder.optionB;
      const fruit=FRUITS.find(f=>f.key===opt.fruitKey);

      const order={fruitKey:opt.fruitKey,amount:opt.amount,by:player};
      orders.push(order);
      lastOrderPlayer=player;

      const cardEl=document.createElement("div");
      cardEl.className="order-card";
      const icon=document.createElement("span");
      icon.textContent=fruit.emoji;
      const text=document.createElement("span");
      text.textContent=`${fruit.label} Ã— ${opt.amount}ï¼ˆ${hostPlayers[player].name}ï¼‰`;
      cardEl.appendChild(icon);cardEl.appendChild(text);
      $("ordersList").appendChild(cardEl);
      $("ordersList").scrollTop=$("ordersList").scrollHeight;

      updateOrdersSummary();
      $("lastOrderPlayerLabel").textContent=hostPlayers[lastOrderPlayer].name;

      choosingOrder=false;
      pendingOrder=null;
      $("orderOverlay").style.display="none";

      if(roomId){
        db.ref("rooms/"+roomId+"/game/pendingOrder").remove();
      }

      const next=(player+1)%playerCount;
      currentPlayer=next;
      updateTurnIndicators();
      $("drawBtn").disabled=false;
      $("bellBtn").disabled=false;

      const msg=`${hostPlayers[player].name} ä¸‹å•ï¼š${fruit.emoji}${opt.amount}ï¼›ä¸‹ä¸€ä½ï¼š${hostPlayers[next].name}`;
      $("infoBox").innerHTML=msg;
      if(roomId){
        db.ref("rooms/"+roomId+"/game").update({
          orders,
          lastOrderPlayer,
          currentPlayer,
          infoText:msg
        });
      }
    }

    function performRing(seat){
      if(gameOver || canStartNextRound) return;
      if(choosingOrder) return;
      if(orders.length===0){
        const msg="æ²¡æœ‰è®¢å•ï¼Œä¸èƒ½æ‘‡é“ƒã€‚";
        $("infoBox").innerHTML=msg;
        if(roomId) db.ref("rooms/"+roomId+"/game/infoText").set(msg);
        return;
      }
      if(lastOrderPlayer===null){
        const msg="è¿˜æ²¡æœ‰æœ‰æ•ˆä¸‹å•è®°å½•ï¼Œæš‚ä¸èƒ½ç»“ç®—ã€‚";
        $("infoBox").innerHTML=msg;
        if(roomId) db.ref("rooms/"+roomId+"/game/infoText").set(msg);
        return;
      }
      finalizeBell(seat,lastOrderPlayer);
    }

    function performNextRound(){
      if(!canStartNextRound || gameOver) return;
      canStartNextRound=false;
      $("nextRoundBtn").disabled=true;
      roundNumber+=1;
      roundStartPlayer=(roundStartPlayer+1)%playerCount;
      currentPlayer=roundStartPlayer;
      startNewRound(false);
    }

    function finalizeBell(challenger,lastOrderP){
      if(gameOver) return;
      $("drawBtn").disabled=true;
      $("bellBtn").disabled=true;

      const hasMickey=inventoryCards.some(c=>c && c.type==="green_star");
      const hasNancy=inventoryCards.some(c=>c && c.type==="banana_inf");

      const rawTotals={grape:0,strawberry:0,banana:0,durian:0};
      orders.forEach(o=>{rawTotals[o.fruitKey]+=o.amount;});

      const effectiveTotals={grape:0,strawberry:0,banana:0,durian:0};
      let cancelledByMickey=0;
      let cancelledByNancy=0;

      orders.forEach(o=>{
        let cancelled=false;
        if(hasNancy && o.fruitKey==="banana"){ cancelled=true;cancelledByNancy++; }
        if(hasMickey && o.amount===3){ cancelled=true;cancelledByMickey++; }
        if(!cancelled) effectiveTotals[o.fruitKey]+=o.amount;
      });

      const totalInventory={grape:0,strawberry:0,banana:0,durian:0};
      inventoryCards.forEach(card=>{
        if(!card) return;
        if(card.type==="zero"){
        }else if(card.type==="banana_inf"){
          FRUITS.forEach(f=>{
            if(f.key==="banana") totalInventory[f.key]=Infinity;
            else{
              const v=card.fruits && typeof card.fruits[f.key]==="number"?card.fruits[f.key]:0;
              totalInventory[f.key]+=v;
            }
          });
        }else{
          FRUITS.forEach(f=>{
            const v=card.fruits && typeof card.fruits[f.key]==="number"?card.fruits[f.key]:0;
            totalInventory[f.key]+=v;
          });
        }
      });

      let oversold=false;
      FRUITS.forEach(f=>{
        const o=effectiveTotals[f.key];
        const inv=totalInventory[f.key];
        if(o>inv && o>0) oversold=true;
      });

      const angerGain=Math.min(angerToken,7);
      let angryIdx;
      const nameCh=hostPlayers[challenger].name;
      const nameLast=hostPlayers[lastOrderP].name;

      const rawDesc=FRUITS.map(f=>`${f.emoji}${rawTotals[f.key]}`).join("ï¼Œ");
      const effDesc=FRUITS.map(f=>`${f.emoji}${effectiveTotals[f.key]}`).join("ï¼Œ");
      const invDesc=FRUITS.map(f=>{
        const v=totalInventory[f.key];
        return `${f.emoji}${v===Infinity?"âˆ":v}`;
      }).join("ï¼Œ");

      let gorillaInfo="";
      if(hasNancy) gorillaInfo+=`é¦™è•‰å—å¸Œï¼šå–æ¶ˆé¦™è•‰è®¢å• ${cancelledByNancy} å¼ ã€‚`;
      if(hasMickey){
        if(gorillaInfo) gorillaInfo+=" ";
        gorillaInfo+=`3å·ç±³å¥‡ï¼šå–æ¶ˆæ•°å­—ä¸º 3 çš„è®¢å• ${cancelledByMickey} å¼ ã€‚`;
      }

      let resultText="";
      if(oversold){
        angryIdx=lastOrderP;
        hostPlayers[angryIdx].anger+=angerGain;
        resultText=`åˆ¤å®šï¼šçˆ†å•ï¼è´£ä»»äººï¼š${nameLast}ï¼Œ+${angerGain} æ„¤æ€’ã€‚`;
      }else{
        angryIdx=challenger;
        hostPlayers[angryIdx].anger+=angerGain;
        resultText=`åˆ¤å®šï¼šæœªçˆ†å•ã€‚è´£ä»»äººï¼š${nameCh}ï¼ˆè¯¯åˆ¤ï¼‰ï¼Œ+${angerGain} æ„¤æ€’ã€‚`;
      }
      if(angerToken<7) angerToken++;

      updateAngerUI();
      updateOrdersSummary(effectiveTotals);

      let info=
        `ç»“ç®—ï¼šåŸå§‹è®¢å• ${rawDesc}ï¼›æœ‰æ•ˆè®¢å• ${effDesc}ï¼›åº“å­˜ ${invDesc}ã€‚<br>`+
        (gorillaInfo?("ç‰¹æ®Šï¼š"+gorillaInfo+"<br>"):"")+
        resultText+`<br>å½“å‰æ„¤æ€’æ ‡è®°ï¼š${angerToken>7?7:angerToken}ã€‚`;
      $("infoBox").innerHTML=info;

      if(roomId){
        db.ref("rooms/"+roomId).update({
          players:hostPlayers.map((p,i)=>({
            name:p.name, anger:p.anger, seat:i,
            inventory:inventoryCards[i]||null
          }))
        });
      }

      let someoneOver=null;
      let minAnger=Infinity;
      hostPlayers.forEach((p,idx)=>{
        if(p.anger>=ANGER_LIMIT && someoneOver===null) someoneOver=idx;
        if(p.anger<minAnger) minAnger=p.anger;
      });

      if(someoneOver!==null){
        gameOver=true;
        const winners=[];
        hostPlayers.forEach((p,idx)=>{
          if(p.anger===minAnger) winners.push(idx);
        });
        let endText=
          `<br><strong>${hostPlayers[someoneOver].name} æ„¤æ€’å€¼è¾¾åˆ° ${ANGER_LIMIT}ï¼Œæ¸¸æˆç»“æŸã€‚</strong><br>`;
        if(winners.length===1) endText+=`è·èƒœè€…ï¼š${hostPlayers[winners[0]].name}`;
        else endText+=`è·èƒœè€…ï¼š`+winners.map(i=>hostPlayers[i].name).join("ã€");
        $("infoBox").innerHTML+=endText;

        if(roomId){
          db.ref("rooms/"+roomId+"/game").update({
            infoText:(info+endText).replace(/<[^>]*>/g,""),
            gameOver:true
          });
        }
        $("nextRoundBtn").disabled=true;
        canStartNextRound=false;
      }else{
        const nextRoundNumber=roundNumber+1;
        const predictedStarter=(roundStartPlayer+1)%playerCount;
        $("infoBox").innerHTML+=`<br><br>æœ¬å±€ç»“æŸã€‚ç¬¬ ${nextRoundNumber} å±€å…ˆæ‰‹ï¼š${hostPlayers[predictedStarter].name}`;
        canStartNextRound=true;
        $("nextRoundBtn").disabled=false;

        if(roomId){
          db.ref("rooms/"+roomId+"/game").update({
            orders,
            lastOrderPlayer:-1,
            angerToken,
            infoText:(info).replace(/<[^>]*>/g,""),
            gameOver:false
          });
        }
      }
    }

    // ====== ç©å®¶æ¨¡å¼ ======
    let playerSeat = null;
    let playerRoomPlayers = null; // ç¼“å­˜ç©å®¶ä¿¡æ¯ï¼Œç»™è®¢å•æ˜¾ç¤ºåå­—å’Œæ„¤æ€’æ¡ç”¨

    function initPlayerMode(){
      const rid=getQueryParam("room");
      const seatStr=getQueryParam("seat");
      if(!rid || seatStr===null){
        $("playerRoomLabel").textContent="å‚æ•°ä¸å®Œæ•´ï¼Œè¯·ä½¿ç”¨ä¸»æœºæä¾›çš„é“¾æ¥ã€‚";
        $("playerCardView").innerHTML="é“¾æ¥æ— æ•ˆ";
        return;
      }
      roomId = rid;
      playerSeat = parseInt(seatStr,10);
      $("playerRoomLabel").textContent=`æˆ¿é—´ï¼š${rid} Â· åº§ä½ï¼š${playerSeat+1}`;

      const playersRef = db.ref("rooms/"+rid+"/players");
      const gameRef = db.ref("rooms/"+rid+"/game");

      playersRef.on("value", snap=>{
        const players = snap.val();
        playerRoomPlayers = players || null;

        const pContainer = $("pPlayersContainer");
        pContainer.innerHTML = "";

        if(!players){
          $("playerCardView").innerHTML="æˆ¿é—´ä¸å­˜åœ¨æˆ–æœªåˆ›å»ºã€‚";
          return;
        }
        const p = players[playerSeat];
        if(!p){
          $("playerCardView").innerHTML="è¯¥åº§ä½æœªè¢«ä½¿ç”¨ã€‚";
        }else{
          const name=p.name||("ç©å®¶"+(playerSeat+1));
          const inv=p.inventory;
          if(!inv){
            $("playerCardView").innerHTML=`${name}<br><br>æœ¬å±€åº“å­˜ç‰Œå°šæœªå‘æ”¾æˆ–å°šæœªå¼€å§‹ã€‚`;
          }else{
            const desc=describeInventoryCardShort(inv);
            $("playerCardView").innerHTML=
              `${name} çš„åº“å­˜ç‰Œï¼š<br><br>${desc}<br><small>æ³¨æ„ä¸è¦æŠŠå±å¹•ç»™å¯¹æ‰‹çœ‹ã€‚</small>`;
          }
        }

        // å¡«å……ç©å®¶çŠ¶æ€åˆ—è¡¨ + æ„¤æ€’æ¡
        const keys = Object.keys(players).sort((a,b)=>parseInt(a,10)-parseInt(b,10));
        keys.forEach(k=>{
          const idx = parseInt(k,10);
          const pl = players[k];
          if(!pl) return;
          const name = pl.name || ("ç©å®¶"+(idx+1));
          const anger = pl.anger || 0;
          const pct = Math.min(anger/ANGER_LIMIT,1)*100;
          const row = document.createElement("div");
          row.className = "p-player-row";
          row.innerHTML =
            `<div class="p-player-name">åº§ä½ ${idx+1}ï¼š${name}</div>
             <div class="anger-bar"><div class="anger-fill" style="width:${pct}%;"></div></div>
             <div class="p-player-anger-text">æ„¤æ€’ï¼š${anger}</div>`;
          pContainer.appendChild(row);
        });
      });

      gameRef.on("value", snap=>{
        const g = snap.val();
        if(!g){
          $("playerInfoText").innerHTML="ç­‰å¾…ä¸»æœºå¼€å§‹æ¸¸æˆâ€¦";
          $("orderOverlay").style.display="none";
          $("pOrdersSummary").textContent="å½“å‰è¿˜æ²¡æœ‰è®¢å•ã€‚";
          $("pOrdersList").innerHTML = "";
          return;
        }

        const info=g.infoText || "ç­‰å¾…ä¸»æœºæ“ä½œâ€¦";
        $("playerInfoText").innerHTML=info;

        const isMyTurn = (g.currentPlayer===playerSeat);
        $("pDrawBtn").disabled = !isMyTurn || g.gameOver;

        // ç©å®¶ä¾§è®¢å•åŒºæ˜¾ç¤º
        const ordersArr = g.orders || [];
        const pSummary = $("pOrdersSummary");
        const pList = $("pOrdersList");
        if(ordersArr.length===0){
          pSummary.textContent = "å½“å‰è¿˜æ²¡æœ‰è®¢å•ã€‚";
          pList.innerHTML = "";
        }else{
          const totals={grape:0,strawberry:0,banana:0,durian:0};
          ordersArr.forEach(o=>{
            if(typeof totals[o.fruitKey]==="number"){
              totals[o.fruitKey]+=o.amount;
            }
          });
          const frags=[];
          FRUITS.forEach(f=>{
            frags.push(`<span>${f.emoji}${f.label}ï¼š${totals[f.key]}</span>`);
          });
          pSummary.innerHTML = frags.join("");

          let listHtml = "";
          ordersArr.forEach(o=>{
            const fruit = FRUITS.find(f=>f.key===o.fruitKey);
            const emoji = fruit ? fruit.emoji : "â“";
            const label = fruit ? fruit.label : "æ°´æœ";
            let name = "æœªçŸ¥";
            if(playerRoomPlayers && playerRoomPlayers[o.by]){
              name = playerRoomPlayers[o.by].name || ("ç©å®¶"+(o.by+1));
            }else{
              name = "ç©å®¶"+(o.by+1);
            }
            listHtml += `<div class="order-card"><span>${emoji}</span><span>${label} Ã— ${o.amount}ï¼ˆ${name}ï¼‰</span></div>`;
          });
          pList.innerHTML = listHtml;
        }

        // å¦‚æœè½®åˆ°æˆ‘é€‰è®¢å•ï¼Œå¼¹å‡ºåŒæ°´æœé€‰æ‹©
        const pending = g.pendingOrder;
        if(pending && pending.by === playerSeat && pending.awaitingChoice){
          const fruitA = FRUITS.find(f=>f.key===pending.optionA.fruitKey);
          const fruitB = FRUITS.find(f=>f.key===pending.optionB.fruitKey);
          $("orderOverlayTitle").textContent = "ä½ æ‘¸åˆ°ä¸¤ç§è®¢å•ï¼Œé€‰æ‹©å…¶ä¸€ï¼š";
          $("orderOptAEmoji").textContent = fruitA ? fruitA.emoji : "A";
          $("orderOptAText").textContent = (fruitA ? fruitA.label : "æ°´æœ") + " Ã— " + pending.optionA.amount;
          $("orderOptBEmoji").textContent = fruitB ? fruitB.emoji : "B";
          $("orderOptBText").textContent = (fruitB ? fruitB.label : "æ°´æœ") + " Ã— " + pending.optionB.amount;
          $("orderOverlay").style.display = "flex";
        }else{
          $("orderOverlay").style.display = "none";
        }
      });
    }

    function enqueueActionPlayer(type){
      if(!roomId || playerSeat===null || !db) return;
      const refActions=db.ref("rooms/"+roomId+"/actions");
      refActions.push({
        type, seat:playerSeat, ts:Date.now(), processed:false
      });
    }

    function playerDrawClick(){
      enqueueActionPlayer("draw");
    }
    function playerBellClick(){
      enqueueActionPlayer("bell");
    }
    function playerNextRoundClick(){
      enqueueActionPlayer("nextRound");
    }
    function playerResetClick(){
      enqueueActionPlayer("resetGame");
    }

    function playerChooseOrder(side){
      if(!roomId || playerSeat===null) return;
      const type = side === "A" ? "chooseA" : "chooseB";
      const refActions = db.ref("rooms/"+roomId+"/actions");
      refActions.push({
        type,
        seat: playerSeat,
        ts: Date.now(),
        processed: false
      });
      $("orderOverlay").style.display = "none";
    }

    // æ‰‹æœºç«¯ä¸€é”®åˆ‡å›ä¸»æœºæ¨¡å¼ï¼ˆåˆ›å»ºæ–°æˆ¿é—´ï¼‰
    function gotoHostMode(){
      const url = location.origin + location.pathname;
      location.href = url;
    }

    // ====== æ¨¡å¼åˆ‡æ¢ ======
    function toggleToHostMode(){
      $("hostRoot").style.display="flex";
      $("playerRoot").style.display="none";
    }
    function toggleToPlayerMode(){
      $("hostRoot").style.display="none";
      $("playerRoot").style.display="flex";
    }

    window.onload=function(){
      const mode=getQueryParam("mode");
      if(mode==="player"){
        toggleToPlayerMode();
        initPlayerMode();
      }else{
        toggleToHostMode();
        $("infoBox").innerHTML="åˆ›å»ºæˆ¿é—´åï¼ŒæŠŠæ¯ä¸ªåº§ä½çš„åŠ å…¥é“¾æ¥å‘ç»™æœ‹å‹ã€‚æœ‹å‹ç”¨æ‰‹æœºå³å¯çœ‹ç‰Œå¹¶æ“ä½œã€‚";
      }
    };
  </script>
</body>
</html>
